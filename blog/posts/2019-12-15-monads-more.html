<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Too lazy to evaluate - モナドを見分けるコツ</title>
        <link rel="stylesheet" href="../css/syntax.css" />
        <link rel="stylesheet" href="../css/default.css" />
        
        
    </head>
    <body>
        <header>
            <div class="logo">
                <a href="../">Too lazy to evaluate</a>
            </div>
            <nav>
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </nav>
        </header>

        <main role="main">
            <h1>モナドを見分けるコツ</h1>
            <article>
    <section class="header">
        
            Posted on 2019-12-15
        
        
    </section>
    <section>
        <h1 id="概要">概要</h1>
<p>広い範囲の多項式Functorについて、Monadになれるかどうかがわかった。</p>
<h1 id="準備">準備</h1>
<p>ここでは、<strong>多項式Functor</strong>を、次の形をしたFunctor <code>F</code> のことと定義します。</p>
<pre><code>F(x) ~ x^(a_0) + x^(a_1) + x^(a_2) + ... + x^(a_k)</code></pre>
<p>ただし、<code>~</code>は<code>x</code>について自然な同型、<code>+</code>は直和型、<code>x^a</code>は<code>x</code>の<code>a</code>個の直積とします。 また、項の数<code>k</code>は0以上、すなわち<code>F(x)</code>は<code>Void</code>でもよいとします。また、<code>a_i</code>も0でもよいとします。 <code>x^0</code>はUnit型、ただ1つの値のみを持つ型です。</p>
<ul>
<li>Remark.
<ul>
<li>有限個の値をとる型<code>e</code>に対して、<code>F(x) = Either e x, G(x) = (e,x), H(x) = e -&gt; x</code>はすべて多項式Functorです。</li>
<li>同じく<code>Const e</code>も多項式Functorです。</li>
<li>多項式Functor<code>F, G</code>について、<code>(F :+: G)(x) = F x + G x</code>, <code>(F :*: G)(x) = F x * G x</code>は多項式Functorです。</li>
<li>多項式Functorの合成は多項式Functorです。</li>
<li>多項式Functor<code>F</code>は常に<code>Traversable</code>にできます。</li>
</ul></li>
</ul>
<p>よく知っているMonadのほとんどが多項式Functorです。ただし、ここでは<code>e</code>を有限な型とします。</p>
<ul>
<li>Identity Functor <code>newtype Id x = Id x</code></li>
<li><code>Either e</code></li>
<li><code>(,) e = Writer e</code></li>
<li><code>(-&gt;) e = Reader e</code></li>
<li><code>Maybe = Either ()</code></li>
<li><code>Proxy = Const ()</code></li>
</ul>
<p>多項式Functorでないものももちろんあります。例えば<code>Cont r</code>がそうです。</p>
<p>また、すでにあるMonadのインスタンスから、新たなインスタンスを次々構成する方法が多数あります。 各種Monad Transformerなどはおなじみかと思いますが、それ以外にも次のようなものがあります：</p>
<ul>
<li><p>Monadの積。<code>Data.Functor.Product</code>という名前で<code>base</code>にもあるので、Monad則の証明は省きます。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> (<span class="op">*</span>) f g a <span class="ot">=</span> f a <span class="op">:*:</span> g a</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Monad</span> f, <span class="dt">Monad</span> g) <span class="ot">=&gt;</span> <span class="dt">Monad</span> (f <span class="op">*</span> g)</span></code></pre></div></li>
<li><p>単位の付加。モナド<code>M</code>に対して<code>T(x) = x + M(x)</code>もモナドにできます。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">T</span> m x <span class="ot">=</span> <span class="dt">TPure</span> x <span class="op">|</span> <span class="dt">TLift</span> (m x)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ot">lower ::</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">T</span> m x <span class="ot">-&gt;</span> m x</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>lower (<span class="dt">TPure</span> x)  <span class="ot">=</span> <span class="fu">return</span> x</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>lower (<span class="dt">TLift</span> mx) <span class="ot">=</span> mx</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">T</span> m) <span class="kw">where</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="ot">=</span> <span class="dt">TPure</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">TPure</span> a  <span class="op">&gt;&gt;=</span> k <span class="ot">=</span> k a</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">TLift</span> ma <span class="op">&gt;&gt;=</span> k <span class="ot">=</span> <span class="dt">TLift</span> <span class="op">$</span> ma <span class="op">&gt;&gt;=</span> lower <span class="op">.</span> k</span></code></pre></div>
<p>単位則は簡単なので省き、結合則のみ示します。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 次の補題をまず示す。</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">--   lower ma &gt;&gt;= lower . k  =  lower (ma &gt;&gt;= k)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>lower (<span class="dt">TPure</span> a) <span class="op">&gt;&gt;=</span> lower <span class="op">.</span> k</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="fu">return</span> a <span class="op">&gt;&gt;=</span> lower <span class="op">.</span> k</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> lower (k a)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> lower (<span class="dt">TPure</span> a <span class="op">&gt;&gt;=</span> k)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>lower (<span class="dt">TLift</span> ma) <span class="op">&gt;&gt;=</span> lower <span class="op">.</span> k</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> ma <span class="op">&gt;&gt;=</span> lower <span class="op">.</span> k</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> lower (<span class="dt">TLift</span> <span class="op">$</span> ma <span class="op">&gt;&gt;=</span> lower <span class="op">.</span> k)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> lower (<span class="dt">TLift</span> ma <span class="op">&gt;&gt;=</span> k)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>(<span class="dt">TPure</span> a <span class="op">&gt;&gt;=</span> f) <span class="op">&gt;&gt;=</span> g</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> f a <span class="op">&gt;&gt;=</span> g</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">TPure</span> a <span class="op">&gt;&gt;=</span> (f <span class="op">&gt;=&gt;</span> g)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>(<span class="dt">TLift</span> ma <span class="op">&gt;&gt;=</span> f) <span class="op">&gt;&gt;=</span> g</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> (<span class="dt">TLift</span> <span class="op">$</span> ma <span class="op">&gt;&gt;=</span> lower <span class="op">.</span> f) <span class="op">&gt;&gt;=</span> g</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">TLift</span> <span class="op">$</span> (ma <span class="op">&gt;&gt;=</span> lower <span class="op">.</span> f) <span class="op">&gt;&gt;=</span> lower <span class="op">.</span> g</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- `Monad m`のMonad則によって変形できる</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">TLift</span> <span class="op">$</span> ma <span class="op">&gt;&gt;=</span> \a <span class="ot">-&gt;</span> lower (f a) <span class="op">&gt;&gt;=</span> lower <span class="op">.</span> g</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- 補題を使う</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">TLift</span> <span class="op">$</span> ma <span class="op">&gt;&gt;=</span> \a <span class="ot">-&gt;</span> lower (f a <span class="op">&gt;&gt;=</span> g)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">TLift</span> <span class="op">$</span> ma <span class="op">&gt;&gt;=</span> lower <span class="op">.</span> (\a <span class="ot">-&gt;</span> f a <span class="op">&gt;&gt;=</span> g)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">TLift</span> ma <span class="op">&gt;&gt;=</span> \a <span class="ot">-&gt;</span> (f a <span class="op">&gt;&gt;=</span> g)</span></code></pre></div></li>
</ul>
<h1 id="本論">本論</h1>
<p>ある多項式Functor <code>F</code>に対して、<code>F</code>のMonadのインスタンスが定義できるだろうか？という問題を考えます。 まず、これが常に可能であるわけではありません。例えば、<code>F ~ Const e</code>は<code>e</code>が2つ以上の異なる値を持つときにMonadになりません。加えて、先日の記事では以下の事実を示しました。</p>
<blockquote>
<p><code>F ~ Maybe (e -&gt; x)</code> は、<code>e</code>が2つ以上の異なる値を持つときにMonadにならない</p>
</blockquote>
<p>一方で、非常に広い範囲の多項式Functorに対してMonadのインスタンスが定義できることもわかっています。 これらを組み合わせて、任意の多項式Functorに対してMonadのインスタンスが定義できるかどうかを判定する方法を示します。</p>
<ul>
<li><p>主張0: ある多項式Functor<code>F</code>が <code>F(x) ~ c</code> と書けるならば、<code>|c| = 1</code>のとき、またそのときに限り<code>F</code>のMonadのインスタンスが存在する。</p></li>
<li><p>主張1: ある多項式Functor<code>F</code>が <code>F(x) ~ x * G(x)</code> と書けるならば、<code>F</code>のMonadのインスタンスが存在する。</p></li>
<li><p>主張2: ある多項式Functor<code>F</code>が <code>F(x) ~ 1 + x + G(x)</code> と書けるならば、<code>F</code>のMonadのインスタンスが存在する。</p></li>
<li><p>主張3: ある多項式Functor<code>F</code>が <code>F(x) ~ c + x^2 * G(x)</code>(<code>|c| &gt;= 1, G(x) ~/~ 0</code>)と書けるならば、<code>F</code>のMonadのインスタンスが存在しない。</p></li>
<li><p>結論: <code>F(x) ~ c + x * b + x^2 * A(x)</code> に対してMonadのインスタンスが存在する ⇔ 以下のいずれかが成り立つ</p>
<ul>
<li><code>c = 1, b = 0, A(x) ~ 0</code></li>
<li><code>c = 0, b = 0, A(x) ~/~ 0</code></li>
<li><code>b &gt;= 1</code></li>
</ul></li>
</ul>
<p>主張0 ~ 主張3から結論が出ることは簡単に確かめられます。</p>
<h2 id="主張0">主張0</h2>
<blockquote>
<p>ある多項式Functor<code>F</code>が <code>F(x) ~ c</code> と書けるならば、<code>|c| = 1</code>のとき、またそのときに限り<code>F</code>のMonadのインスタンスが存在する。</p>
</blockquote>
<h3 id="証明">証明</h3>
<p>（以下、証明部分は常体で書きます）</p>
<p>(⇒)は<a href="http://hackage.haskell.org/package/base-4.12.0.0/docs/Data-Proxy.html#t:Proxy">Proxy</a>と同じようにMonadのインスタンスが定義できることからわかる。</p>
<p>(⇐)を示す。<code>pure :: x -&gt; F x</code> はある定数関数 <code>const c0</code> である。このとき、<code>c0 :: F x ~ c</code> である。 任意の<code>c1 :: F x ~ c</code>について、<code>join (pure c1) = join (const c0 c1) = join c0</code>となるが、Monad則より<code>join . pure = id</code>なので<code>join (pure c1) = c1</code>でもある。したがって、任意の<code>c</code>型の値は<code>join c0</code>に等しい。これはすなわち、<code>|c| = 1</code>を意味する。</p>
<h2 id="主張1">主張1</h2>
<blockquote>
<p>ある多項式Functor<code>F</code>が <code>F(x) ~ x * G(x)</code> と書けるならば、<code>F</code>のMonadのインスタンスが存在する。</p>
</blockquote>
<p>例をあげると、</p>
<ul>
<li><code>F(x) ~ x + x^3</code></li>
<li><code>F(x) ~ x^2 + x^5 + x^6</code></li>
</ul>
<p>のように、「定数項」のないFunctorはMonadにできます。</p>
<h3 id="証明-1">証明</h3>
<p><code>F(x)</code>の項の数<code>k</code>および多項式の次数に関する帰納法を用いる。<code>k=1</code>のとき、すなわち<code>F(x) = x^a</code>のとき、<code>F</code>のMonadのインスタンスがあるのは明らか。</p>
<ul>
<li><p><code>k&gt;1</code>, かつ <code>G(x) ~ x * H(x)</code>と書けるならば、<code>G(x)</code>の次数は<code>F(x)</code>より小さいので、帰納法の仮定を用いれば <code>G(x)</code> はMonadにできる。<code>F(x) ~ x * G(x) ~ (Id * G)(x)</code>かつIdもGもMonadなので、Monadの積によって<code>F(x)</code>もMonadのインスタンスを持てる。</p></li>
<li><p><code>k&gt;1</code>, かつ<code>G(x) ~ x * H(x)</code>と書けないならば、<code>G(x) ~ 1 + H(x)</code>と書ける。このとき、</p>
<pre><code>F(x) ~ x * (1 + H(x)) ~ x + x * H(x) ~ x + (Id * H)(x)</code></pre>
<p>かつ、<code>(Id * H)(x)</code>の項の数は<code>F(x)</code>より一つ少ないので、帰納法の仮定を用いれば<code>(Id * H)(x)</code>はMonadにできる。 よって、先程述べた“単位の付加”の構成により、<code>F(x) ~ x + (Id * H)(x)</code>はMonadにできる。</p></li>
</ul>
<h2 id="主張2">主張2</h2>
<blockquote>
<p>ある多項式Functor<code>F</code>が <code>F(x) ~ 1 + x + G(x)</code> と書けるならば、<code>F</code>のMonadのインスタンスが存在する。</p>
</blockquote>
<p>例:</p>
<ul>
<li><code>F(x) ~ c + b * x</code>, 言い換えれば <code>F x = Either C (B, x)</code>であるとき、<code>c &gt;= 1</code>, <code>b &gt;= 1</code>ならばMonadのインスタンスが存在します。<code>F x ~ WriterT B (Either C) x</code>、および任意の空でない型<code>B</code>に対して<code>Monoid B</code>が定義できることを考えれば、これは納得がいきます。</li>
<li><code>F(x) ~ 1 + x + x^2 + x^3</code>, 長さが 0 〜 3 のリストにはMonadのインスタンスが存在します。</li>
</ul>
<h3 id="証明-2">証明</h3>
<p>どの多項式FunctorもTraversableにできるのであった。<code>G(x)</code>も<code>Traversable</code>であると仮定してよい。 次のように <code>F x ~ U g x = 1 + x + g x</code> とそのMonadのインスタンスを定義する。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">U</span> g x <span class="ot">=</span> <span class="dt">Nothing'</span> <span class="op">|</span> <span class="dt">Just'</span> x <span class="op">|</span> <span class="dt">Wrap</span> (g x)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ot">toMaybe ::</span> <span class="dt">U</span> g x <span class="ot">-&gt;</span> <span class="dt">Maybe</span> x</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>toMaybe (<span class="dt">Just'</span> x) <span class="ot">=</span> <span class="dt">Just</span> x</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>toMaybe _         <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Traversable</span> g) <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">U</span> g x) <span class="kw">where</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="ot">=</span> <span class="dt">Just'</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Nothing'</span> <span class="op">&gt;&gt;=</span> _ <span class="ot">=</span> <span class="dt">Nothing'</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Just'</span> a  <span class="op">&gt;&gt;=</span> k <span class="ot">=</span> k a</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Wrap</span> ga  <span class="op">&gt;&gt;=</span> k <span class="ot">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="op">$</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> k) ga</span></code></pre></div>
<p>これがMonad則を満たすことを確認する。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>[toMaybeは<span class="dt">Monad</span> morphism]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>toMaybe <span class="op">.</span> <span class="fu">return</span> <span class="ot">=</span> toMaybe <span class="op">.</span> <span class="dt">Just'</span> <span class="ot">=</span> <span class="dt">Just</span> <span class="ot">=</span> <span class="fu">return</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>toMaybe (ma <span class="op">&gt;&gt;=</span> k)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="kw">case</span> ma <span class="kw">of</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Nothing'</span> <span class="ot">-&gt;</span> toMaybe (<span class="dt">Nothing'</span> <span class="op">&gt;&gt;=</span> k)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Just'</span> a  <span class="ot">-&gt;</span> toMaybe (<span class="dt">Just'</span> a <span class="op">&gt;&gt;=</span> k)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Wrap</span> ga  <span class="ot">-&gt;</span> toMaybe (<span class="dt">Wrap</span> ga <span class="op">&gt;&gt;=</span> k)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="kw">case</span> ma <span class="kw">of</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Nothing'</span> <span class="ot">-&gt;</span> toMaybe <span class="dt">Nothing'</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Just'</span> a  <span class="ot">-&gt;</span> toMaybe (k a)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Wrap</span> ga  <span class="ot">-&gt;</span> toMaybe (<span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="op">$</span> <span class="op">...</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="kw">case</span> ma <span class="kw">of</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Nothing'</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Just'</span> a  <span class="ot">-&gt;</span> toMaybe (k a)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Wrap</span> _   <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="kw">case</span> toMaybe ma <span class="kw">of</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Just</span> a  <span class="ot">-&gt;</span> toMaybe (k a)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> toMaybe ma <span class="op">&gt;&gt;=</span> toMaybe <span class="op">.</span> k</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>(系) toMaybe (f <span class="op">&gt;=&gt;</span> g) <span class="ot">=</span> toMaybe f <span class="op">&gt;=&gt;</span> toMaybe g</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>[左単位] <span class="fu">return</span> a <span class="op">&gt;&gt;=</span> k <span class="ot">=</span> k a</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span> a <span class="op">&gt;&gt;=</span> k</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">Just'</span> a <span class="op">&gt;&gt;=</span> k</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> k a</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>[右単位] ma <span class="op">&gt;&gt;=</span> <span class="fu">return</span> <span class="ot">=</span> ma</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="dt">Nothing'</span> <span class="op">&gt;&gt;=</span> <span class="fu">return</span> <span class="ot">=</span> <span class="dt">Nothing'</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="dt">Just'</span> a  <span class="op">&gt;&gt;=</span> <span class="fu">return</span> <span class="ot">=</span> <span class="dt">Just'</span> a</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="dt">Wrap</span> ga  <span class="op">&gt;&gt;=</span> <span class="fu">return</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="op">$</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> <span class="fu">return</span>) ga</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="op">$</span> <span class="fu">traverse</span> <span class="dt">Just</span> ga</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- traverse則, traverse pure = pure および pure @Maybe = Just</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="op">$</span> <span class="dt">Just</span> ga</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">Wrap</span> ga</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>[結合] (ma <span class="op">&gt;&gt;=</span> f) <span class="op">&gt;&gt;=</span> g <span class="ot">=</span> ma <span class="op">&gt;&gt;=</span> (f <span class="op">&gt;=&gt;</span> g)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>(<span class="dt">Nothing'</span> <span class="op">&gt;&gt;=</span> f) <span class="op">&gt;&gt;=</span> g   <span class="ot">=</span>   <span class="dt">Nothing'</span>    <span class="ot">=</span>   <span class="dt">Nothing'</span> <span class="op">&gt;&gt;=</span> (f <span class="op">&gt;=&gt;</span> g)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>(<span class="dt">Just'</span> a  <span class="op">&gt;&gt;=</span> f) <span class="op">&gt;&gt;=</span> g   <span class="ot">=</span>   f a <span class="op">&gt;&gt;=</span> g   <span class="ot">=</span>   <span class="dt">Just'</span> a  <span class="op">&gt;&gt;=</span> (f <span class="op">&gt;=&gt;</span> g)</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>(<span class="dt">Wrap</span> ga <span class="op">&gt;&gt;=</span> f) <span class="op">&gt;&gt;=</span> g</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> (<span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="op">$</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> f) ga) <span class="op">&gt;&gt;=</span> g</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="kw">case</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> f) ga <span class="kw">of</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing'</span> <span class="op">&gt;&gt;=</span> g</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Just</span> gb <span class="ot">-&gt;</span> <span class="dt">Wrap</span> gb <span class="op">&gt;&gt;=</span> g</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="kw">case</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> f) ga <span class="kw">of</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing'</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Just</span> gb <span class="ot">-&gt;</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="op">$</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> g) gb</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="op">$</span> <span class="kw">case</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> f) ga <span class="kw">of</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Just</span> gb <span class="ot">-&gt;</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> g) gb</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="op">$</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> f) ga <span class="op">&gt;&gt;=</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> g)</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a><span class="dt">Wrap</span> ga <span class="op">&gt;&gt;=</span> (f <span class="op">&gt;=&gt;</span> g)</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="op">$</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> (f <span class="op">&gt;=&gt;</span> g)) ga</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- toMaybe が Monad morphismであることを用いる</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="op">$</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> f <span class="op">&gt;=&gt;</span> toMaybe <span class="op">.</span> g) ga</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Maybeでtraverse補題(後述)を用いる</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="op">$</span> (<span class="fu">traverse</span> (toMaybe <span class="op">.</span> f) <span class="op">&gt;=&gt;</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> g)) ga</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="op">$</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> f) ga <span class="op">&gt;&gt;=</span> <span class="fu">traverse</span> (toMaybe <span class="op">.</span> g)</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>[<span class="dt">Maybe</span>でtraverse補題]</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>任意の</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a><span class="ot">    f ::</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> b</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a><span class="ot">    g ::</span> b <span class="ot">-&gt;</span> <span class="dt">Maybe</span> c</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>に対して、</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">traverse</span> (f <span class="op">&gt;=&gt;</span> g) <span class="ot">=</span> <span class="fu">traverse</span> f <span class="op">&gt;=&gt;</span> <span class="fu">traverse</span> g</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>(証明)</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a><span class="ot">    join' ::</span> <span class="kw">forall</span> x<span class="op">.</span> <span class="dt">Compose</span> <span class="dt">Maybe</span> <span class="dt">Maybe</span> x <span class="ot">-&gt;</span> <span class="dt">Maybe</span> x</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>    join' (<span class="dt">Compose</span> mmx) <span class="ot">=</span> join mmx</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>を用いると、</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    f <span class="op">&gt;=&gt;</span> g <span class="ot">=</span> join' <span class="op">.</span> <span class="dt">Compose</span> <span class="op">.</span> <span class="fu">fmap</span> g <span class="op">.</span> f</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>と変形できる。</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>また、証明は略するが join' は<span class="dt">Applicative</span> transformation である。</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>    join' <span class="op">.</span> <span class="fu">pure</span> <span class="ot">=</span> <span class="fu">pure</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>    join' (x <span class="op">&lt;*&gt;</span> y) <span class="ot">=</span> join' x <span class="op">&lt;*&gt;</span> join' y</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>よって、</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">traverse</span> (f <span class="op">&gt;=&gt;</span> g)</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>      <span class="ot">=</span> <span class="fu">traverse</span> (join' <span class="op">.</span> <span class="dt">Compose</span> <span class="op">.</span> <span class="fu">fmap</span> g <span class="op">.</span> f)</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- Traversable則 naturality</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>      <span class="ot">=</span> join' <span class="op">.</span> <span class="fu">traverse</span> (<span class="dt">Compose</span> <span class="op">.</span> <span class="fu">fmap</span> g <span class="op">.</span> f)</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- Traversable則 composition</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>      <span class="ot">=</span> join' <span class="op">.</span> <span class="dt">Compose</span> <span class="op">.</span> <span class="fu">fmap</span> (<span class="fu">traverse</span> g) <span class="op">.</span> <span class="fu">traverse</span> f</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- join' の定義</span></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>      <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> (<span class="fu">traverse</span> g) <span class="op">.</span> <span class="fu">traverse</span> f</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- (&gt;=&gt;) の定義</span></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>      <span class="ot">=</span> <span class="fu">traverse</span> f <span class="op">&gt;=&gt;</span> <span class="fu">traverse</span> g</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>(証明終)</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>(注<span class="op">:</span>一般の<span class="dt">Monad</span>に対してjoin'は<span class="dt">Applicative</span> transformationにならないので、</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a><span class="dt">Maybe</span>を任意の<span class="dt">Monad</span>に置き換えることはできない。)</span></code></pre></div>
<h2 id="主張3">主張3</h2>
<p><strong>2019.12.16 追記</strong> ― 証明を読みやすく、あと有限性に依存しないようにできたので<a href="./2019-12-16-fixed-proof-for-monads-more.html">修正版を投稿しました</a></p>
<blockquote>
<p>ある多項式Functor<code>F</code>が <code>F(x) ~ c + x^2 * G(x)</code>(<code>|c| &gt;= 1, G(x) ~/~ 0</code>)と書けるならば、<code>F</code>のMonadのインスタンスは存在しない。</p>
</blockquote>
<p>例:</p>
<ul>
<li><code>F(x) ~ 1 + x^2</code></li>
<li><code>F(x) ~ 3 + x^2 + x^4</code></li>
</ul>
<h3 id="証明-3">証明</h3>
<p>まず、どんな多項式Functorに対しても、<code>forall x. x -&gt; F x</code>という型を持つ関数があれば、それは<code>F(x)</code>の特定の項 <code>F(x) ~ ... + x^n + ...</code>に対応するコンストラクタに、<code>n</code>個の<code>x</code>のコピーを渡した値を返す。このコンストラクタは、当然、<code>x</code>に依存せずに決まる。</p>
<p>いま問題としている<code>F(x) ~ c + x^2 * G(x)</code>において、Monadの定義における<code>return :: forall x. x -&gt; F x</code>に対応する項が<code>x^n</code>であるとしたら、<code>n == 0</code>であるか、または<code>n &gt;= 2</code>である。</p>
<p>仮に<code>n == 0</code>であったとする。これはすなわち<code>return</code>は定数関数であり、<code>return x</code>の値は<code>x</code>に依存しないことを意味している。しかし、Monad則より<code>join (return fx) = fx</code>でなければならず、また空でない型<code>X</code>において<code>fx :: F X</code>は2つ以上の異なる値を持つので、<code>return</code>は定数関数であってはならない。したがって、<code>n &gt;= 2</code>でなければならない。</p>
<p><code>return</code>の返り値に対応する項<code>x^n</code>を明示して、<code>F(x)</code>が以下のように定義されているとする。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">N</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">C</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">G</span> x <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">F</span> x <span class="ot">=</span> <span class="dt">U</span> (<span class="dt">N</span> <span class="ot">-&gt;</span> x) <span class="op">|</span> <span class="dt">L</span> <span class="dt">C</span> <span class="op">|</span> <span class="dt">R</span> x x (<span class="dt">G</span> x)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span><span class="ot"> ::</span> <span class="kw">forall</span> x<span class="op">.</span> x <span class="ot">-&gt;</span> <span class="dt">F</span> x</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span> x <span class="ot">=</span> <span class="dt">U</span> (<span class="fu">const</span> x)</span></code></pre></div>
<p>また、前提条件として与えられている、<code>C</code>に1つ以上の値があることが、次のように表されているとする。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- |C| &gt;= 1</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ot">c0 ::</span> <span class="dt">C</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ot">zero ::</span> <span class="kw">forall</span> x<span class="op">.</span> <span class="dt">F</span> x</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>zero <span class="ot">=</span> <span class="dt">L</span> c0</span></code></pre></div>
<p>簡単にわかることとして、<code>join zero = zero</code>がある。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>join (<span class="dt">L</span> c0)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a> <span class="co">-- fmap f (L c) = L c</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join (<span class="fu">fmap</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">L</span> c0)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">L</span> c0</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a> <span class="co">-- join . fmap return = id</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">L</span> c0</span></code></pre></div>
<p>Monad則から、<code>join :: F (F x) -&gt; F x</code>の満たすべき等式として次のものが得られる。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- ∀a :: N -&gt; N -&gt; x</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>join <span class="op">$</span> <span class="dt">U</span> (\i <span class="ot">-&gt;</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> a i j)) <span class="ot">=</span> <span class="dt">U</span> <span class="op">$</span> \i <span class="ot">-&gt;</span> a i i</span></code></pre></div>
<p>以降、この等式は<code>joinUU</code>という名前で呼ぶ。また、これは次のように証明できる。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ot">coord ::</span> <span class="dt">F</span> (<span class="dt">F</span> (<span class="dt">N</span>, <span class="dt">N</span>))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>coord <span class="ot">=</span> <span class="dt">U</span> <span class="op">$</span> \i <span class="ot">-&gt;</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> (i,j)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">fmap</span> <span class="fu">fst</span> (join coord)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join (<span class="fu">fmap</span> (<span class="fu">fmap</span> <span class="fu">fst</span>) coord)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join (<span class="dt">U</span> <span class="op">$</span> \i <span class="ot">-&gt;</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> i)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join (<span class="dt">U</span> <span class="op">$</span> \i <span class="ot">-&gt;</span> <span class="fu">return</span> i)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join (<span class="fu">fmap</span> <span class="fu">return</span> (<span class="dt">U</span> <span class="op">$</span> \i <span class="ot">-&gt;</span> i))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Monad則(join . fmap return = id)</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">U</span> <span class="op">$</span> \i <span class="ot">-&gt;</span> i</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="fu">fmap</span> <span class="fu">snd</span> (join coord)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join (<span class="fu">fmap</span> (<span class="fu">fmap</span> <span class="fu">snd</span>) coord)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join (<span class="dt">U</span> <span class="op">$</span> \i <span class="ot">-&gt;</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> j)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join (<span class="fu">return</span> <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> j)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Monad則(join . return = id)</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> j</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>join coord <span class="ot">=</span> <span class="dt">U</span> <span class="op">$</span> \i <span class="ot">-&gt;</span> (i,i)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>join <span class="op">$</span> <span class="dt">U</span> (\i <span class="ot">-&gt;</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> a i j))</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="fu">fmap</span> (<span class="fu">fmap</span> (<span class="fu">uncurry</span> a)) coord</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">fmap</span> (<span class="fu">uncurry</span> a) <span class="op">$</span> join coord</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">fmap</span> (<span class="fu">uncurry</span> a) <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \i <span class="ot">-&gt;</span> (i,i)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">U</span> <span class="op">$</span> \i <span class="ot">-&gt;</span> a i i</span></code></pre></div>
<p>ここで、次の関数を考える。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ot">at ::</span> <span class="kw">forall</span> x<span class="op">.</span> <span class="dt">N</span> <span class="ot">-&gt;</span> x <span class="ot">-&gt;</span> <span class="dt">F</span> x</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>at i x <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> <span class="fu">return</span> x <span class="kw">else</span> zero)</span></code></pre></div>
<p>いま、ある<code>i :: N</code>において<code>at i x</code>が<code>x</code>に依存しないと仮定する。 このとき、次の<code>sweep f</code>は<code>f i</code>の値に依存しないはずである。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ot">sweep ::</span> <span class="kw">forall</span> x<span class="op">.</span> (<span class="dt">N</span> <span class="ot">-&gt;</span> x) <span class="ot">-&gt;</span> <span class="dt">F</span> (<span class="dt">F</span> x)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>sweep f <span class="ot">=</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> at j (f j)</span></code></pre></div>
<p>一方、<code>join $ sweep f</code>を<code>join</code>の結合則を用いて計算すると、以下のようになる。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>join <span class="op">$</span> sweep f</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> at j (f j))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> join <span class="op">$</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> j <span class="op">==</span> k <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> j <span class="op">==</span> k <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero))</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a> <span class="co">-- 結合則</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> j <span class="op">==</span> k <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero))</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a> <span class="co">-- joinUU</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> j <span class="op">==</span> j <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="fu">return</span> (f j))</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> f j)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a> <span class="co">-- 単位則</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">U</span> f</span></code></pre></div>
<p>これは明らかに<code>f</code>の任意の点<code>i :: N</code>での値に依存する。これは矛盾である。</p>
<ul>
<li><strong>事実1</strong>: 任意の<code>i</code>に対して<code>at i x</code>は<code>x</code>に依存する。</li>
</ul>
<p>次に、<code>at i /= return</code>を示す。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">U</span> f <span class="op">&gt;&gt;=</span> <span class="fu">return</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">U</span> f</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="dt">U</span> f <span class="op">&gt;&gt;=</span> at i</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> at i (f j))</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> join <span class="op">$</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> k <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> k <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> k <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero))</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> <span class="fu">return</span> (f i) <span class="kw">else</span> zero)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> at i (f i)</span></code></pre></div>
<p>いま、<code>N</code>には2つ以上の異なる値があるので、<code>i' /= i</code>なる<code>i' :: N</code>が存在して、<code>U f</code>は<code>f i</code>にも<code>f i'</code>にも依存する。 しかし、<code>at i (f i)</code>は<code>f i</code>にしか依存しないので、<code>at i = return</code> ではありえない。</p>
<ul>
<li><strong>事実2</strong>: 任意の<code>i</code>に対して<code>at i /= return</code></li>
</ul>
<p>加えて、</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ot">hole ::</span> (<span class="dt">N</span> <span class="ot">-&gt;</span> x) <span class="ot">-&gt;</span> <span class="dt">N</span> <span class="ot">-&gt;</span> (x <span class="ot">-&gt;</span> <span class="dt">F</span> x) <span class="ot">-&gt;</span> <span class="dt">F</span> x</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>hole f i u <span class="ot">=</span> join <span class="op">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> u (f j) <span class="kw">else</span> <span class="fu">return</span> (f j)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>hole f i (at k)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> at k (f j) <span class="kw">else</span> <span class="fu">return</span> (f j)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>     <span class="kw">then</span> join <span class="op">$</span> <span class="dt">U</span> (\l <span class="ot">-&gt;</span> <span class="kw">if</span> k <span class="op">==</span> l <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>     <span class="kw">else</span> join <span class="op">.</span> <span class="fu">return</span> <span class="op">.</span> <span class="fu">return</span> <span class="op">$</span> f j</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>     <span class="kw">then</span> <span class="dt">U</span> (\l <span class="ot">-&gt;</span> <span class="kw">if</span> k <span class="op">==</span> l <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>     <span class="kw">else</span> <span class="dt">U</span> (\_ <span class="ot">-&gt;</span> <span class="fu">return</span> (f j))</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a> <span class="co">-- 結合則 + joinUU</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> i <span class="op">==</span> j</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>       <span class="kw">then</span> <span class="kw">if</span> k <span class="op">==</span> j <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>       <span class="kw">else</span> <span class="fu">return</span> (f j)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">-- i == k のとき</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>hole f i (at k) <span class="op">|</span> i <span class="op">==</span> k</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> (i <span class="op">==</span> j) <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> <span class="fu">return</span> (f j)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> <span class="fu">return</span> (f j)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">U</span> f</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- i /= k のとき</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>hole f i (at k) <span class="op">|</span> i <span class="op">/=</span> k</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> <span class="fu">return</span> (f j)</span></code></pre></div>
<p>より、<code>hole f i (at k)</code>が<code>f i</code>に依存するかどうかは、<code>i == k</code>かどうかによって決まる。したがって、<code>i /= k</code>のとき、<code>at i /= at k</code>である。</p>
<ul>
<li><strong>事実3</strong>: 任意の<code>i, k :: N</code>に対して、<code>i /= k</code>ならば<code>at i /= at k</code></li>
</ul>
<p>いま、<code>at i x</code>は<code>x</code>に依存するのであった。<code>return</code>のときと同様の議論によって、<code>at i x</code>が返すコンストラクタは2つ以上の<code>x</code>の値に依存することができるので、関数<code>con :: N -&gt; x -&gt; x -&gt; F x</code>が存在して、<code>con i x y</code>は<code>x</code>と<code>y</code>の両方に依存し、 <code>con i x x = at i x</code>となるようにできる。</p>
<p><code>con i</code>に関する等式をいくつか示す。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> at i x)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> join (<span class="fu">return</span> zero) <span class="kw">else</span> join <span class="op">$</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> k <span class="kw">then</span> <span class="fu">return</span> x <span class="kw">else</span> zero))</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> <span class="fu">return</span> zero <span class="kw">else</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> k <span class="kw">then</span> <span class="fu">return</span> x <span class="kw">else</span> zero)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> <span class="dt">U</span> <span class="op">$</span> \k <span class="ot">-&gt;</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> (<span class="kw">if</span> i <span class="op">==</span> k <span class="kw">then</span> <span class="fu">return</span> x <span class="kw">else</span> zero)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> (<span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> <span class="fu">return</span> x <span class="kw">else</span> zero)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> zero</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="fu">return</span> zero</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> zero</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- Because `join` can't discriminate between `at i x = con i x x` and `con i x y`:</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> con i x y)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> zero</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>join <span class="op">$</span> at i (con i x y)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> <span class="fu">return</span> (con i x y) <span class="kw">else</span> zero)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> join (<span class="fu">return</span> (con i x y)) <span class="kw">else</span> join zero)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> con i x y <span class="kw">else</span> zero)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Use above equation in reversed direction</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> i <span class="op">==</span> j</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>       <span class="kw">then</span> con i x y</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>       <span class="kw">else</span> join <span class="op">$</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> k <span class="kw">then</span> zero <span class="kw">else</span> con i x y)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> i <span class="op">==</span> j</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>       <span class="kw">then</span> join <span class="op">$</span> <span class="fu">return</span> (con i x y)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>       <span class="kw">else</span> join <span class="op">$</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> k <span class="kw">then</span> zero <span class="kw">else</span> con i x y)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> <span class="dt">U</span> <span class="op">$</span> \k <span class="ot">-&gt;</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> i <span class="op">==</span> j</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>       <span class="kw">then</span> con i x y</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>       <span class="kw">else</span> (<span class="kw">if</span> i <span class="op">==</span> k <span class="kw">then</span> zero <span class="kw">else</span> con i x y)</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> i <span class="op">==</span> j</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>       <span class="kw">then</span> con i x y</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>       <span class="kw">else</span> (<span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> con i x y)</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> con i x y</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> <span class="fu">return</span> <span class="op">$</span> con i x y</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> con i x y</span></code></pre></div>
<p>いま、次の関数<code>extra</code>を考える。</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ot">extra ::</span> <span class="kw">forall</span> x<span class="op">.</span> <span class="dt">N</span> <span class="ot">-&gt;</span> x <span class="ot">-&gt;</span> x <span class="ot">-&gt;</span> (<span class="dt">N</span> <span class="ot">-&gt;</span> x) <span class="ot">-&gt;</span> <span class="dt">F</span> x</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>extra i x y f <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> con i x y <span class="kw">else</span> <span class="fu">return</span> (f j))</span></code></pre></div>
<p>次の計算によって、2つのことがわかる。</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>extra i (f i) (f i) f</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> con i (f i) (f i) <span class="kw">else</span> <span class="fu">return</span> (f j))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> at i (f i) <span class="kw">else</span> <span class="fu">return</span> (f j))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> hole f i (at i)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">U</span> f</span></code></pre></div>
<p>まず、<code>extra</code>は<code>x</code>に関して自然なので、任意の<code>x, y, f</code>に関して<code>extra i x y f = U _</code>とならなければならない。 また、<code>extra i x y f</code>は任意の<code>j /= i</code>における<code>f j</code>と、<code>x</code>, <code>y</code>のいずれか片方に依存する。</p>
<p>さらに、</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>join <span class="op">$</span> at i (extra i x y f)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> extra i x y f <span class="kw">else</span> zero</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> i <span class="op">==</span> j</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>       <span class="kw">then</span> join <span class="op">$</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> k <span class="kw">then</span> con i x y <span class="kw">else</span> <span class="fu">return</span> (f k))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>       <span class="kw">else</span> join (<span class="fu">return</span> zero)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> join <span class="op">.</span> <span class="fu">fmap</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> i <span class="op">==</span> j</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>       <span class="kw">then</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> k <span class="kw">then</span> con i x y <span class="kw">else</span> <span class="fu">return</span> (f k))</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>       <span class="kw">else</span> <span class="fu">return</span> zero</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> join <span class="op">.</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> <span class="dt">U</span> <span class="op">$</span> \k <span class="ot">-&gt;</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> i <span class="op">==</span> j</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>       <span class="kw">then</span> <span class="kw">if</span> i <span class="op">==</span> k <span class="kw">then</span> con i x y <span class="kw">else</span> <span class="fu">return</span> (f k)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>       <span class="kw">else</span> zero</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> i <span class="op">==</span> j</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>       <span class="kw">then</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> con i x y <span class="kw">else</span> <span class="fu">return</span> (f j)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>       <span class="kw">else</span> zero</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">.</span> join <span class="op">$</span> <span class="dt">U</span> <span class="op">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="op">==</span> j <span class="kw">then</span> con i x y <span class="kw">else</span> zero</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> join <span class="op">$</span> at i (con i x y)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> con i x y</span></code></pre></div>
<p>である。したがって、<code>extra i x y f</code>は<code>x</code>と<code>y</code>の両方に依存する。</p>
<p>さて、<code>extra i x y f = U g</code>と書くことができ、<code>g :: N -&gt; x</code>なのであった。<code>g</code>は任意の<code>j /= i</code>における<code>f j</code>、<code>x</code>、そして<code>y</code>のいずれにも依存する。しかし、<code>N</code>が有限であればこれは<code>N+1</code>個の独立な変数なので、これは不可能である。</p>
<ul>
<li><strong>事実4</strong>: <code>N</code>は無限個の異なる値をとる。</li>
</ul>
<p>さらに、<code>at i</code>は各<code>i</code>について異なる必要があるので、</p>
<ul>
<li><strong>事実5</strong>: <code>F(x)</code>は無限個の項の和である。</li>
</ul>
<p>いま、多項式Functorは、有限な型<code>a_i</code>について<code>x^(a_i)</code>の有限個の直和型として定義したのであった。よって、ここで定義した<code>F(x)</code>は<code>Monad</code>になることはない。</p>
    </section>
</article>

        </main>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
    </body>
</html>
