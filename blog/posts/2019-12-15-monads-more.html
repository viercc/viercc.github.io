<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Too lazy to evaluate - モナドを見分けるコツ</title>
        <link rel="stylesheet" href="../css/syntax.css" />
        <link rel="stylesheet" href="../css/default.css" />
    </head>
    <body>
        <header>
            <div class="logo">
                <a href="../">Too lazy to evaluate</a>
            </div>
            <nav>
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </nav>
        </header>

        <main role="main">
            <h1>モナドを見分けるコツ</h1>
            <article>
    <section class="header">
        Posted on December 15, 2019
        
    </section>
    <section>
        <h1 id="概要">概要</h1>
<p>広い範囲の多項式Functorについて、Monadになれるかどうかがわかった。</p>
<h1 id="準備">準備</h1>
<p>ここでは、<strong>多項式Functor</strong>を、次の形をしたFunctor <code>F</code> のことと定義します。</p>
<pre><code>F(x) ~ x^(a_0) + x^(a_1) + x^(a_2) + ... + x^(a_k)</code></pre>
<p>ただし、<code>~</code>は<code>x</code>について自然な同型、<code>+</code>は直和型、<code>x^a</code>は<code>x</code>の<code>a</code>個の直積とします。 また、項の数<code>k</code>は0以上、すなわち<code>F(x)</code>は<code>Void</code>でもよいとします。また、<code>a_i</code>も0でもよいとします。 <code>x^0</code>はUnit型、ただ1つの値のみを持つ型です。</p>
<ul>
<li>Remark.
<ul>
<li>有限個の値をとる型<code>e</code>に対して、<code>F(x) = Either e x, G(x) = (e,x), H(x) = e -&gt; x</code>はすべて多項式Functorです。</li>
<li>同じく<code>Const e</code>も多項式Functorです。</li>
<li>多項式Functor<code>F, G</code>について、<code>(F :+: G)(x) = F x + G x</code>, <code>(F :*: G)(x) = F x * G x</code>は多項式Functorです。</li>
<li>多項式Functorの合成は多項式Functorです。</li>
<li>多項式Functor<code>F</code>は常に<code>Traversable</code>にできます。</li>
</ul></li>
</ul>
<p>よく知っているMonadのほとんどが多項式Functorです。ただし、ここでは<code>e</code>を有限な型とします。</p>
<ul>
<li>Identity Functor <code>newtype Id x = Id x</code></li>
<li><code>Either e</code></li>
<li><code>(,) e = Writer e</code></li>
<li><code>(-&gt;) e = Reader e</code></li>
<li><code>Maybe = Either ()</code></li>
<li><code>Proxy = Const ()</code></li>
</ul>
<p>多項式Functorでないものももちろんあります。例えば<code>Cont r</code>がそうです。</p>
<p>また、すでにあるMonadのインスタンスから、新たなインスタンスを次々構成する方法が多数あります。 各種Monad Transformerなどはおなじみかと思いますが、それ以外にも次のようなものがあります：</p>
<ul>
<li><p>Monadの積。<code>Data.Functor.Product</code>という名前で<code>base</code>にもあるので、Monad則の証明は省きます。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">newtype</span> (<span class="fu">*</span>) f g a <span class="fu">=</span> f a <span class="fu">:*:</span> g a</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">instance</span> (<span class="dt">Monad</span> f, <span class="dt">Monad</span> g) <span class="ot">=&gt;</span> <span class="dt">Monad</span> (f <span class="fu">*</span> g)</a></code></pre></div></li>
<li><p>単位の付加。モナド<code>M</code>に対して<code>T(x) = x + M(x)</code>もモナドにできます。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">data</span> <span class="dt">T</span> m x <span class="fu">=</span> <span class="dt">TPure</span> x <span class="fu">|</span> <span class="dt">TLift</span> (m x)</a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="ot">lower ::</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">T</span> m x <span class="ot">-&gt;</span> m x</a>
<a class="sourceLine" id="cb3-4" title="4">lower (<span class="dt">TPure</span> x)  <span class="fu">=</span> <span class="fu">return</span> x</a>
<a class="sourceLine" id="cb3-5" title="5">lower (<span class="dt">TLift</span> mx) <span class="fu">=</span> mx</a>
<a class="sourceLine" id="cb3-6" title="6"></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="kw">instance</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">T</span> m) <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-8" title="8">  <span class="fu">return</span> <span class="fu">=</span> <span class="dt">TPure</span></a>
<a class="sourceLine" id="cb3-9" title="9">  <span class="dt">TPure</span> a  <span class="fu">&gt;&gt;=</span> k <span class="fu">=</span> k a</a>
<a class="sourceLine" id="cb3-10" title="10">  <span class="dt">TLift</span> ma <span class="fu">&gt;&gt;=</span> k <span class="fu">=</span> <span class="dt">TLift</span> <span class="fu">$</span> ma <span class="fu">&gt;&gt;=</span> lower <span class="fu">.</span> k</a></code></pre></div>
<p>単位則は簡単なので省き、結合則のみ示します。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="co">-- 次の補題をまず示す。</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="co">--   lower ma &gt;&gt;= lower . k  =  lower (ma &gt;&gt;= k)</span></a>
<a class="sourceLine" id="cb4-3" title="3">lower (<span class="dt">TPure</span> a) <span class="fu">&gt;&gt;=</span> lower <span class="fu">.</span> k</a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="fu">=</span> <span class="fu">return</span> a <span class="fu">&gt;&gt;=</span> lower <span class="fu">.</span> k</a>
<a class="sourceLine" id="cb4-5" title="5">  <span class="fu">=</span> lower (k a)</a>
<a class="sourceLine" id="cb4-6" title="6">  <span class="fu">=</span> lower (<span class="dt">TPure</span> a <span class="fu">&gt;&gt;=</span> k)</a>
<a class="sourceLine" id="cb4-7" title="7">lower (<span class="dt">TLift</span> ma) <span class="fu">&gt;&gt;=</span> lower <span class="fu">.</span> k</a>
<a class="sourceLine" id="cb4-8" title="8">  <span class="fu">=</span> ma <span class="fu">&gt;&gt;=</span> lower <span class="fu">.</span> k</a>
<a class="sourceLine" id="cb4-9" title="9">  <span class="fu">=</span> lower (<span class="dt">TLift</span> <span class="fu">$</span> ma <span class="fu">&gt;&gt;=</span> lower <span class="fu">.</span> k)</a>
<a class="sourceLine" id="cb4-10" title="10">  <span class="fu">=</span> lower (<span class="dt">TLift</span> ma <span class="fu">&gt;&gt;=</span> k)</a>
<a class="sourceLine" id="cb4-11" title="11"></a>
<a class="sourceLine" id="cb4-12" title="12">(<span class="dt">TPure</span> a <span class="fu">&gt;&gt;=</span> f) <span class="fu">&gt;&gt;=</span> g</a>
<a class="sourceLine" id="cb4-13" title="13">  <span class="fu">=</span> f a <span class="fu">&gt;&gt;=</span> g</a>
<a class="sourceLine" id="cb4-14" title="14">  <span class="fu">=</span> <span class="dt">TPure</span> a <span class="fu">&gt;&gt;=</span> (f <span class="fu">&gt;=&gt;</span> g)</a>
<a class="sourceLine" id="cb4-15" title="15"></a>
<a class="sourceLine" id="cb4-16" title="16">(<span class="dt">TLift</span> ma <span class="fu">&gt;&gt;=</span> f) <span class="fu">&gt;&gt;=</span> g</a>
<a class="sourceLine" id="cb4-17" title="17">  <span class="fu">=</span> (<span class="dt">TLift</span> <span class="fu">$</span> ma <span class="fu">&gt;&gt;=</span> lower <span class="fu">.</span> f) <span class="fu">&gt;&gt;=</span> g</a>
<a class="sourceLine" id="cb4-18" title="18">  <span class="fu">=</span> <span class="dt">TLift</span> <span class="fu">$</span> (ma <span class="fu">&gt;&gt;=</span> lower <span class="fu">.</span> f) <span class="fu">&gt;&gt;=</span> lower <span class="fu">.</span> g</a>
<a class="sourceLine" id="cb4-19" title="19">    <span class="co">-- `Monad m`のMonad則によって変形できる</span></a>
<a class="sourceLine" id="cb4-20" title="20">  <span class="fu">=</span> <span class="dt">TLift</span> <span class="fu">$</span> ma <span class="fu">&gt;&gt;=</span> \a <span class="ot">-&gt;</span> lower (f a) <span class="fu">&gt;&gt;=</span> lower <span class="fu">.</span> g</a>
<a class="sourceLine" id="cb4-21" title="21">    <span class="co">-- 補題を使う</span></a>
<a class="sourceLine" id="cb4-22" title="22">  <span class="fu">=</span> <span class="dt">TLift</span> <span class="fu">$</span> ma <span class="fu">&gt;&gt;=</span> \a <span class="ot">-&gt;</span> lower (f a <span class="fu">&gt;&gt;=</span> g)</a>
<a class="sourceLine" id="cb4-23" title="23">  <span class="fu">=</span> <span class="dt">TLift</span> <span class="fu">$</span> ma <span class="fu">&gt;&gt;=</span> lower <span class="fu">.</span> (\a <span class="ot">-&gt;</span> f a <span class="fu">&gt;&gt;=</span> g)</a>
<a class="sourceLine" id="cb4-24" title="24">  <span class="fu">=</span> <span class="dt">TLift</span> ma <span class="fu">&gt;&gt;=</span> \a <span class="ot">-&gt;</span> (f a <span class="fu">&gt;&gt;=</span> g)</a></code></pre></div></li>
</ul>
<h1 id="本論">本論</h1>
<p>ある多項式Functor <code>F</code>に対して、<code>F</code>のMonadのインスタンスが定義できるだろうか？という問題を考えます。 まず、これが常に可能であるわけではありません。例えば、<code>F ~ Const e</code>は<code>e</code>が2つ以上の異なる値を持つときにMonadになりません。加えて、先日の記事では以下の事実を示しました。</p>
<blockquote>
<p><code>F ~ Maybe (e -&gt; x)</code> は、<code>e</code>が2つ以上の異なる値を持つときにMonadにならない</p>
</blockquote>
<p>一方で、非常に広い範囲の多項式Functorに対してMonadのインスタンスが定義できることもわかっています。 これらを組み合わせて、任意の多項式Functorに対してMonadのインスタンスが定義できるかどうかを判定する方法を示します。</p>
<ul>
<li>主張0: ある多項式Functor<code>F</code>が <code>F(x) ~ c</code> と書けるならば、<code>|c| = 1</code>のとき、またそのときに限り<code>F</code>のMonadのインスタンスが存在する。</li>
<li>主張1: ある多項式Functor<code>F</code>が <code>F(x) ~ x * G(x)</code> と書けるならば、<code>F</code>のMonadのインスタンスが存在する。</li>
<li>主張2: ある多項式Functor<code>F</code>が <code>F(x) ~ 1 + x + G(x)</code> と書けるならば、<code>F</code>のMonadのインスタンスが存在する。</li>
<li>主張3: ある多項式Functor<code>F</code>が <code>F(x) ~ c + x^2 * G(x)</code>(<code>|c| &gt;= 1, G(x) ~/~ 0</code>)と書けるならば、<code>F</code>のMonadのインスタンスが存在しない。</li>
<li><p>結論: <code>F(x) ~ c + x * b + x^2 * A(x)</code> に対してMonadのインスタンスが存在する ⇔ 以下のいずれかが成り立つ</p>
<ul>
<li><code>c = 1, b = 0, A(x) ~ 0</code></li>
<li><code>c = 0, b = 0, A(x) ~/~ 0</code></li>
<li><code>b &gt;= 1</code></li>
</ul></li>
</ul>
<p>主張0 ~ 主張3から結論が出ることは簡単に確かめられます。</p>
<h2 id="主張0">主張0</h2>
<blockquote>
<p>ある多項式Functor<code>F</code>が <code>F(x) ~ c</code> と書けるならば、<code>|c| = 1</code>のとき、またそのときに限り<code>F</code>のMonadのインスタンスが存在する。</p>
</blockquote>
<h3 id="証明">証明</h3>
<p>（以下、証明部分は常体で書きます）</p>
<p>(⇒)は<a href="http://hackage.haskell.org/package/base-4.12.0.0/docs/Data-Proxy.html#t:Proxy">Proxy</a>と同じようにMonadのインスタンスが定義できることからわかる。</p>
<p>(⇐)を示す。<code>pure :: x -&gt; F x</code> はある定数関数 <code>const c0</code> である。このとき、<code>c0 :: F x ~ c</code> である。 任意の<code>c1 :: F x ~ c</code>について、<code>join (pure c1) = join (const c0 c1) = join c0</code>となるが、Monad則より<code>join . pure = id</code>なので<code>join (pure c1) = c1</code>でもある。したがって、任意の<code>c</code>型の値は<code>join c0</code>に等しい。これはすなわち、<code>|c| = 1</code>を意味する。</p>
<h2 id="主張1">主張1</h2>
<blockquote>
<p>ある多項式Functor<code>F</code>が <code>F(x) ~ x * G(x)</code> と書けるならば、<code>F</code>のMonadのインスタンスが存在する。</p>
</blockquote>
<p>例をあげると、</p>
<ul>
<li><code>F(x) ~ x + x^3</code></li>
<li><code>F(x) ~ x^2 + x^5 + x^6</code></li>
</ul>
<p>のように、「定数項」のないFunctorはMonadにできます。</p>
<h3 id="証明-1">証明</h3>
<p><code>F(x)</code>の項の数<code>k</code>および多項式の次数に関する帰納法を用いる。<code>k=1</code>のとき、すなわち<code>F(x) = x^a</code>のとき、<code>F</code>のMonadのインスタンスがあるのは明らか。</p>
<ul>
<li><code>k&gt;1</code>, かつ <code>G(x) ~ x * H(x)</code>と書けるならば、<code>G(x)</code>の次数は<code>F(x)</code>より小さいので、帰納法の仮定を用いれば <code>G(x)</code> はMonadにできる。<code>F(x) ~ x * G(x) ~ (Id * G)(x)</code>かつIdもGもMonadなので、Monadの積によって<code>F(x)</code>もMonadのインスタンスを持てる。</li>
<li><p><code>k&gt;1</code>, かつ<code>G(x) ~ x * H(x)</code>と書けないならば、<code>G(x) ~ 1 + H(x)</code>と書ける。このとき、</p>
<pre><code>F(x) ~ x * (1 + H(x)) ~ x + x * H(x) ~ x + (Id * H)(x)</code></pre>
<p>かつ、<code>(Id * H)(x)</code>の項の数は<code>F(x)</code>より一つ少ないので、帰納法の仮定を用いれば<code>(Id * H)(x)</code>はMonadにできる。 よって、先程述べた“単位の付加”の構成により、<code>F(x) ~ x + (Id * H)(x)</code>はMonadにできる。</p></li>
</ul>
<h2 id="主張2">主張2</h2>
<blockquote>
<p>ある多項式Functor<code>F</code>が <code>F(x) ~ 1 + x + G(x)</code> と書けるならば、<code>F</code>のMonadのインスタンスが存在する。</p>
</blockquote>
<p>例:</p>
<ul>
<li><code>F(x) ~ c + b * x</code>, 言い換えれば <code>F x = Either C (B, x)</code>であるとき、<code>c &gt;= 1</code>, <code>b &gt;= 1</code>ならばMonadのインスタンスが存在します。<code>F x ~ WriterT B (Either C) x</code>、および任意の空でない型<code>B</code>に対して<code>Monoid B</code>が定義できることを考えれば、これは納得がいきます。</li>
<li><code>F(x) ~ 1 + x + x^2 + x^3</code>, 長さが 0 〜 3 のリストにはMonadのインスタンスが存在します。</li>
</ul>
<h3 id="証明-2">証明</h3>
<p>どの多項式FunctorもTraversableにできるのであった。<code>G(x)</code>も<code>Traversable</code>であると仮定してよい。 次のように <code>F x ~ U g x = 1 + x + g x</code> とそのMonadのインスタンスを定義する。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">data</span> <span class="dt">U</span> g x <span class="fu">=</span> <span class="dt">Nothing'</span> <span class="fu">|</span> <span class="dt">Just'</span> x <span class="fu">|</span> <span class="dt">Wrap</span> (g x)</a>
<a class="sourceLine" id="cb6-2" title="2"></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="ot">toMaybe ::</span> <span class="dt">U</span> g x <span class="ot">-&gt;</span> <span class="dt">Maybe</span> x</a>
<a class="sourceLine" id="cb6-4" title="4">toMaybe (<span class="dt">Just'</span> x) <span class="fu">=</span> <span class="dt">Just</span> x</a>
<a class="sourceLine" id="cb6-5" title="5">toMaybe _         <span class="fu">=</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb6-6" title="6"></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="kw">instance</span> (<span class="dt">Traversable</span> g) <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">U</span> g x) <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-8" title="8">  <span class="fu">return</span> <span class="fu">=</span> <span class="dt">Just'</span></a>
<a class="sourceLine" id="cb6-9" title="9">  <span class="dt">Nothing'</span> <span class="fu">&gt;&gt;=</span> _ <span class="fu">=</span> <span class="dt">Nothing'</span></a>
<a class="sourceLine" id="cb6-10" title="10">  <span class="dt">Just'</span> a  <span class="fu">&gt;&gt;=</span> k <span class="fu">=</span> k a</a>
<a class="sourceLine" id="cb6-11" title="11">  <span class="dt">Wrap</span> ga  <span class="fu">&gt;&gt;=</span> k <span class="fu">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="fu">$</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> k) ga</a></code></pre></div>
<p>これがMonad則を満たすことを確認する。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1">[toMaybeは<span class="dt">Monad</span> morphism]</a>
<a class="sourceLine" id="cb7-2" title="2">toMaybe <span class="fu">.</span> <span class="fu">return</span> <span class="fu">=</span> toMaybe <span class="fu">.</span> <span class="dt">Just'</span> <span class="fu">=</span> <span class="dt">Just</span> <span class="fu">=</span> <span class="fu">return</span></a>
<a class="sourceLine" id="cb7-3" title="3"></a>
<a class="sourceLine" id="cb7-4" title="4">toMaybe (ma <span class="fu">&gt;&gt;=</span> k)</a>
<a class="sourceLine" id="cb7-5" title="5"> <span class="fu">=</span> <span class="kw">case</span> ma <span class="kw">of</span></a>
<a class="sourceLine" id="cb7-6" title="6">     <span class="dt">Nothing'</span> <span class="ot">-&gt;</span> toMaybe (<span class="dt">Nothing'</span> <span class="fu">&gt;&gt;=</span> k)</a>
<a class="sourceLine" id="cb7-7" title="7">     <span class="dt">Just'</span> a  <span class="ot">-&gt;</span> toMaybe (<span class="dt">Just'</span> a <span class="fu">&gt;&gt;=</span> k)</a>
<a class="sourceLine" id="cb7-8" title="8">     <span class="dt">Wrap</span> ga  <span class="ot">-&gt;</span> toMaybe (<span class="dt">Wrap</span> ga <span class="fu">&gt;&gt;=</span> k)</a>
<a class="sourceLine" id="cb7-9" title="9"> <span class="fu">=</span> <span class="kw">case</span> ma <span class="kw">of</span></a>
<a class="sourceLine" id="cb7-10" title="10">     <span class="dt">Nothing'</span> <span class="ot">-&gt;</span> toMaybe <span class="dt">Nothing'</span></a>
<a class="sourceLine" id="cb7-11" title="11">     <span class="dt">Just'</span> a  <span class="ot">-&gt;</span> toMaybe (k a)</a>
<a class="sourceLine" id="cb7-12" title="12">     <span class="dt">Wrap</span> ga  <span class="ot">-&gt;</span> toMaybe (<span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="fu">$</span> <span class="fu">...</span>)</a>
<a class="sourceLine" id="cb7-13" title="13"> <span class="fu">=</span> <span class="kw">case</span> ma <span class="kw">of</span></a>
<a class="sourceLine" id="cb7-14" title="14">     <span class="dt">Nothing'</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb7-15" title="15">     <span class="dt">Just'</span> a  <span class="ot">-&gt;</span> toMaybe (k a)</a>
<a class="sourceLine" id="cb7-16" title="16">     <span class="dt">Wrap</span> _   <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb7-17" title="17"> <span class="fu">=</span> <span class="kw">case</span> toMaybe ma <span class="kw">of</span></a>
<a class="sourceLine" id="cb7-18" title="18">     <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb7-19" title="19">     <span class="dt">Just</span> a  <span class="ot">-&gt;</span> toMaybe (k a)</a>
<a class="sourceLine" id="cb7-20" title="20"> <span class="fu">=</span> toMaybe ma <span class="fu">&gt;&gt;=</span> toMaybe <span class="fu">.</span> k</a>
<a class="sourceLine" id="cb7-21" title="21">(系) toMaybe (f <span class="fu">&gt;=&gt;</span> g) <span class="fu">=</span> toMaybe f <span class="fu">&gt;=&gt;</span> toMaybe g</a>
<a class="sourceLine" id="cb7-22" title="22"></a>
<a class="sourceLine" id="cb7-23" title="23">[左単位] <span class="fu">return</span> a <span class="fu">&gt;&gt;=</span> k <span class="fu">=</span> k a</a>
<a class="sourceLine" id="cb7-24" title="24"><span class="fu">return</span> a <span class="fu">&gt;&gt;=</span> k</a>
<a class="sourceLine" id="cb7-25" title="25"> <span class="fu">=</span> <span class="dt">Just'</span> a <span class="fu">&gt;&gt;=</span> k</a>
<a class="sourceLine" id="cb7-26" title="26"> <span class="fu">=</span> k a</a>
<a class="sourceLine" id="cb7-27" title="27"></a>
<a class="sourceLine" id="cb7-28" title="28">[右単位] ma <span class="fu">&gt;&gt;=</span> <span class="fu">return</span> <span class="fu">=</span> ma</a>
<a class="sourceLine" id="cb7-29" title="29"><span class="dt">Nothing'</span> <span class="fu">&gt;&gt;=</span> <span class="fu">return</span> <span class="fu">=</span> <span class="dt">Nothing'</span></a>
<a class="sourceLine" id="cb7-30" title="30"><span class="dt">Just'</span> a  <span class="fu">&gt;&gt;=</span> <span class="fu">return</span> <span class="fu">=</span> <span class="dt">Just'</span> a</a>
<a class="sourceLine" id="cb7-31" title="31"><span class="dt">Wrap</span> ga  <span class="fu">&gt;&gt;=</span> <span class="fu">return</span></a>
<a class="sourceLine" id="cb7-32" title="32"> <span class="fu">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="fu">$</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> <span class="fu">return</span>) ga</a>
<a class="sourceLine" id="cb7-33" title="33"> <span class="fu">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="fu">$</span> <span class="fu">traverse</span> <span class="dt">Just</span> ga</a>
<a class="sourceLine" id="cb7-34" title="34">    <span class="co">-- traverse則, traverse pure = pure および pure @Maybe = Just</span></a>
<a class="sourceLine" id="cb7-35" title="35"> <span class="fu">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="fu">$</span> <span class="dt">Just</span> ga</a>
<a class="sourceLine" id="cb7-36" title="36"> <span class="fu">=</span> <span class="dt">Wrap</span> ga</a>
<a class="sourceLine" id="cb7-37" title="37"></a>
<a class="sourceLine" id="cb7-38" title="38">[結合] (ma <span class="fu">&gt;&gt;=</span> f) <span class="fu">&gt;&gt;=</span> g <span class="fu">=</span> ma <span class="fu">&gt;&gt;=</span> (f <span class="fu">&gt;=&gt;</span> g)</a>
<a class="sourceLine" id="cb7-39" title="39">(<span class="dt">Nothing'</span> <span class="fu">&gt;&gt;=</span> f) <span class="fu">&gt;&gt;=</span> g   <span class="fu">=</span>   <span class="dt">Nothing'</span>    <span class="fu">=</span>   <span class="dt">Nothing'</span> <span class="fu">&gt;&gt;=</span> (f <span class="fu">&gt;=&gt;</span> g)</a>
<a class="sourceLine" id="cb7-40" title="40">(<span class="dt">Just'</span> a  <span class="fu">&gt;&gt;=</span> f) <span class="fu">&gt;&gt;=</span> g   <span class="fu">=</span>   f a <span class="fu">&gt;&gt;=</span> g   <span class="fu">=</span>   <span class="dt">Just'</span> a  <span class="fu">&gt;&gt;=</span> (f <span class="fu">&gt;=&gt;</span> g)</a>
<a class="sourceLine" id="cb7-41" title="41"></a>
<a class="sourceLine" id="cb7-42" title="42">(<span class="dt">Wrap</span> ga <span class="fu">&gt;&gt;=</span> f) <span class="fu">&gt;&gt;=</span> g</a>
<a class="sourceLine" id="cb7-43" title="43"> <span class="fu">=</span> (<span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="fu">$</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> f) ga) <span class="fu">&gt;&gt;=</span> g</a>
<a class="sourceLine" id="cb7-44" title="44"> <span class="fu">=</span> <span class="kw">case</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> f) ga <span class="kw">of</span></a>
<a class="sourceLine" id="cb7-45" title="45">     <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing'</span> <span class="fu">&gt;&gt;=</span> g</a>
<a class="sourceLine" id="cb7-46" title="46">     <span class="dt">Just</span> gb <span class="ot">-&gt;</span> <span class="dt">Wrap</span> gb <span class="fu">&gt;&gt;=</span> g</a>
<a class="sourceLine" id="cb7-47" title="47"> <span class="fu">=</span> <span class="kw">case</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> f) ga <span class="kw">of</span></a>
<a class="sourceLine" id="cb7-48" title="48">     <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing'</span></a>
<a class="sourceLine" id="cb7-49" title="49">     <span class="dt">Just</span> gb <span class="ot">-&gt;</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="fu">$</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> g) gb</a>
<a class="sourceLine" id="cb7-50" title="50"> <span class="fu">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="fu">$</span> <span class="kw">case</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> f) ga <span class="kw">of</span></a>
<a class="sourceLine" id="cb7-51" title="51">     <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb7-52" title="52">     <span class="dt">Just</span> gb <span class="ot">-&gt;</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> g) gb</a>
<a class="sourceLine" id="cb7-53" title="53"> <span class="fu">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="fu">$</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> f) ga <span class="fu">&gt;&gt;=</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> g)</a>
<a class="sourceLine" id="cb7-54" title="54"><span class="dt">Wrap</span> ga <span class="fu">&gt;&gt;=</span> (f <span class="fu">&gt;=&gt;</span> g)</a>
<a class="sourceLine" id="cb7-55" title="55"> <span class="fu">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="fu">$</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> (f <span class="fu">&gt;=&gt;</span> g)) ga</a>
<a class="sourceLine" id="cb7-56" title="56">    <span class="co">-- toMaybe が Monad morphismであることを用いる</span></a>
<a class="sourceLine" id="cb7-57" title="57"> <span class="fu">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="fu">$</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> f <span class="fu">&gt;=&gt;</span> toMaybe <span class="fu">.</span> g) ga</a>
<a class="sourceLine" id="cb7-58" title="58">    <span class="co">-- Maybeでtraverse補題(後述)を用いる</span></a>
<a class="sourceLine" id="cb7-59" title="59"> <span class="fu">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="fu">$</span> (<span class="fu">traverse</span> (toMaybe <span class="fu">.</span> f) <span class="fu">&gt;=&gt;</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> g)) ga</a>
<a class="sourceLine" id="cb7-60" title="60"> <span class="fu">=</span> <span class="fu">maybe</span> <span class="dt">Nothing'</span> <span class="dt">Wrap</span> <span class="fu">$</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> f) ga <span class="fu">&gt;&gt;=</span> <span class="fu">traverse</span> (toMaybe <span class="fu">.</span> g)</a>
<a class="sourceLine" id="cb7-61" title="61"></a>
<a class="sourceLine" id="cb7-62" title="62">[<span class="dt">Maybe</span>でtraverse補題]</a>
<a class="sourceLine" id="cb7-63" title="63">任意の</a>
<a class="sourceLine" id="cb7-64" title="64"><span class="ot">    f ::</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> b</a>
<a class="sourceLine" id="cb7-65" title="65"><span class="ot">    g ::</span> b <span class="ot">-&gt;</span> <span class="dt">Maybe</span> c</a>
<a class="sourceLine" id="cb7-66" title="66">に対して、</a>
<a class="sourceLine" id="cb7-67" title="67">    <span class="fu">traverse</span> (f <span class="fu">&gt;=&gt;</span> g) <span class="fu">=</span> <span class="fu">traverse</span> f <span class="fu">&gt;=&gt;</span> <span class="fu">traverse</span> g</a>
<a class="sourceLine" id="cb7-68" title="68">(証明)</a>
<a class="sourceLine" id="cb7-69" title="69"><span class="ot">    join' ::</span> <span class="kw">forall</span> x<span class="fu">.</span> <span class="dt">Compose</span> <span class="dt">Maybe</span> <span class="dt">Maybe</span> x <span class="ot">-&gt;</span> <span class="dt">Maybe</span> x</a>
<a class="sourceLine" id="cb7-70" title="70">    join' (<span class="dt">Compose</span> mmx) <span class="fu">=</span> join mmx</a>
<a class="sourceLine" id="cb7-71" title="71">を用いると、</a>
<a class="sourceLine" id="cb7-72" title="72">    f <span class="fu">&gt;=&gt;</span> g <span class="fu">=</span> join' <span class="fu">.</span> <span class="dt">Compose</span> <span class="fu">.</span> <span class="fu">fmap</span> g <span class="fu">.</span> f</a>
<a class="sourceLine" id="cb7-73" title="73">と変形できる。</a>
<a class="sourceLine" id="cb7-74" title="74">また、証明は略するが join' は<span class="dt">Applicative</span> transformation である。</a>
<a class="sourceLine" id="cb7-75" title="75">    join' <span class="fu">.</span> <span class="fu">pure</span> <span class="fu">=</span> <span class="fu">pure</span></a>
<a class="sourceLine" id="cb7-76" title="76">    join' (x <span class="fu">&lt;*&gt;</span> y) <span class="fu">=</span> join' x <span class="fu">&lt;*&gt;</span> join' y</a>
<a class="sourceLine" id="cb7-77" title="77">よって、</a>
<a class="sourceLine" id="cb7-78" title="78">    <span class="fu">traverse</span> (f <span class="fu">&gt;=&gt;</span> g)</a>
<a class="sourceLine" id="cb7-79" title="79">      <span class="fu">=</span> <span class="fu">traverse</span> (join' <span class="fu">.</span> <span class="dt">Compose</span> <span class="fu">.</span> <span class="fu">fmap</span> g <span class="fu">.</span> f)</a>
<a class="sourceLine" id="cb7-80" title="80">        <span class="co">-- Traversable則 naturality</span></a>
<a class="sourceLine" id="cb7-81" title="81">      <span class="fu">=</span> join' <span class="fu">.</span> <span class="fu">traverse</span> (<span class="dt">Compose</span> <span class="fu">.</span> <span class="fu">fmap</span> g <span class="fu">.</span> f)</a>
<a class="sourceLine" id="cb7-82" title="82">        <span class="co">-- Traversable則 composition</span></a>
<a class="sourceLine" id="cb7-83" title="83">      <span class="fu">=</span> join' <span class="fu">.</span> <span class="dt">Compose</span> <span class="fu">.</span> <span class="fu">fmap</span> (<span class="fu">traverse</span> g) <span class="fu">.</span> <span class="fu">traverse</span> f</a>
<a class="sourceLine" id="cb7-84" title="84">        <span class="co">-- join' の定義</span></a>
<a class="sourceLine" id="cb7-85" title="85">      <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> (<span class="fu">traverse</span> g) <span class="fu">.</span> <span class="fu">traverse</span> f</a>
<a class="sourceLine" id="cb7-86" title="86">        <span class="co">-- (&gt;=&gt;) の定義</span></a>
<a class="sourceLine" id="cb7-87" title="87">      <span class="fu">=</span> <span class="fu">traverse</span> f <span class="fu">&gt;=&gt;</span> <span class="fu">traverse</span> g</a>
<a class="sourceLine" id="cb7-88" title="88">(証明終)</a>
<a class="sourceLine" id="cb7-89" title="89">(注<span class="fu">:</span>一般の<span class="dt">Monad</span>に対してjoin'は<span class="dt">Applicative</span> transformationにならないので、</a>
<a class="sourceLine" id="cb7-90" title="90"><span class="dt">Maybe</span>を任意の<span class="dt">Monad</span>に置き換えることはできない。)</a></code></pre></div>
<h2 id="主張3">主張3</h2>
<p><strong>2019.12.16 追記</strong> ― 証明を読みやすく、あと有限性に依存しないようにできたので<a href="./2019-12-16-fixed-proof-for-monads-more.html">修正版を投稿しました</a></p>
<blockquote>
<p>ある多項式Functor<code>F</code>が <code>F(x) ~ c + x^2 * G(x)</code>(<code>|c| &gt;= 1, G(x) ~/~ 0</code>)と書けるならば、<code>F</code>のMonadのインスタンスは存在しない。</p>
</blockquote>
<p>例:</p>
<ul>
<li><code>F(x) ~ 1 + x^2</code></li>
<li><code>F(x) ~ 3 + x^2 + x^4</code></li>
</ul>
<h3 id="証明-3">証明</h3>
<p>まず、どんな多項式Functorに対しても、<code>forall x. x -&gt; F x</code>という型を持つ関数があれば、それは<code>F(x)</code>の特定の項 <code>F(x) ~ ... + x^n + ...</code>に対応するコンストラクタに、<code>n</code>個の<code>x</code>のコピーを渡した値を返す。このコンストラクタは、当然、<code>x</code>に依存せずに決まる。</p>
<p>いま問題としている<code>F(x) ~ c + x^2 * G(x)</code>において、Monadの定義における<code>return :: forall x. x -&gt; F x</code>に対応する項が<code>x^n</code>であるとしたら、<code>n == 0</code>であるか、または<code>n &gt;= 2</code>である。</p>
<p>仮に<code>n == 0</code>であったとする。これはすなわち<code>return</code>は定数関数であり、<code>return x</code>の値は<code>x</code>に依存しないことを意味している。しかし、Monad則より<code>join (return fx) = fx</code>でなければならず、また空でない型<code>X</code>において<code>fx :: F X</code>は2つ以上の異なる値を持つので、<code>return</code>は定数関数であってはならない。したがって、<code>n &gt;= 2</code>でなければならない。</p>
<p><code>return</code>の返り値に対応する項<code>x^n</code>を明示して、<code>F(x)</code>が以下のように定義されているとする。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">type</span> <span class="dt">N</span> <span class="fu">=</span> <span class="fu">...</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">type</span> <span class="dt">C</span> <span class="fu">=</span> <span class="fu">...</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="kw">type</span> <span class="dt">G</span> x <span class="fu">=</span> <span class="fu">...</span></a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="kw">data</span> <span class="dt">F</span> x <span class="fu">=</span> <span class="dt">U</span> (<span class="dt">N</span> <span class="ot">-&gt;</span> x) <span class="fu">|</span> <span class="dt">L</span> <span class="dt">C</span> <span class="fu">|</span> <span class="dt">R</span> x x (<span class="dt">G</span> x)</a>
<a class="sourceLine" id="cb8-6" title="6"></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="fu">return</span><span class="ot"> ::</span> <span class="kw">forall</span> x<span class="fu">.</span> x <span class="ot">-&gt;</span> <span class="dt">F</span> x</a>
<a class="sourceLine" id="cb8-8" title="8"><span class="fu">return</span> x <span class="fu">=</span> <span class="dt">U</span> (<span class="fu">const</span> x)</a></code></pre></div>
<p>また、前提条件として与えられている、<code>C</code>に1つ以上の値があることが、次のように表されているとする。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1"><span class="co">-- |C| &gt;= 1</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="ot">c0 ::</span> <span class="dt">C</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="ot">zero ::</span> <span class="kw">forall</span> x<span class="fu">.</span> <span class="dt">F</span> x</a>
<a class="sourceLine" id="cb9-4" title="4">zero <span class="fu">=</span> <span class="dt">L</span> c0</a></code></pre></div>
<p>簡単にわかることとして、<code>join zero = zero</code>がある。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1">join (<span class="dt">L</span> c0)</a>
<a class="sourceLine" id="cb10-2" title="2"> <span class="co">-- fmap f (L c) = L c</span></a>
<a class="sourceLine" id="cb10-3" title="3"> <span class="fu">=</span> join (<span class="fu">fmap</span> <span class="fu">return</span> <span class="fu">$</span> <span class="dt">L</span> c0)</a>
<a class="sourceLine" id="cb10-4" title="4"> <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> <span class="fu">return</span> <span class="fu">$</span> <span class="dt">L</span> c0</a>
<a class="sourceLine" id="cb10-5" title="5"> <span class="co">-- join . fmap return = id</span></a>
<a class="sourceLine" id="cb10-6" title="6"> <span class="fu">=</span> <span class="dt">L</span> c0</a></code></pre></div>
<p>Monad則から、<code>join :: F (F x) -&gt; F x</code>の満たすべき等式として次のものが得られる。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1"><span class="co">-- ∀a :: N -&gt; N -&gt; x</span></a>
<a class="sourceLine" id="cb11-2" title="2">join <span class="fu">$</span> <span class="dt">U</span> (\i <span class="ot">-&gt;</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> a i j)) <span class="fu">=</span> <span class="dt">U</span> <span class="fu">$</span> \i <span class="ot">-&gt;</span> a i i</a></code></pre></div>
<p>以降、この等式は<code>joinUU</code>という名前で呼ぶ。また、これは次のように証明できる。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" title="1"><span class="ot">coord ::</span> <span class="dt">F</span> (<span class="dt">F</span> (<span class="dt">N</span>, <span class="dt">N</span>))</a>
<a class="sourceLine" id="cb12-2" title="2">coord <span class="fu">=</span> <span class="dt">U</span> <span class="fu">$</span> \i <span class="ot">-&gt;</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> (i,j)</a>
<a class="sourceLine" id="cb12-3" title="3"></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="fu">fmap</span> <span class="fu">fst</span> (join coord)</a>
<a class="sourceLine" id="cb12-5" title="5"> <span class="fu">=</span> join (<span class="fu">fmap</span> (<span class="fu">fmap</span> <span class="fu">fst</span>) coord)</a>
<a class="sourceLine" id="cb12-6" title="6"> <span class="fu">=</span> join (<span class="dt">U</span> <span class="fu">$</span> \i <span class="ot">-&gt;</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> i)</a>
<a class="sourceLine" id="cb12-7" title="7"> <span class="fu">=</span> join (<span class="dt">U</span> <span class="fu">$</span> \i <span class="ot">-&gt;</span> <span class="fu">return</span> i)</a>
<a class="sourceLine" id="cb12-8" title="8"> <span class="fu">=</span> join (<span class="fu">fmap</span> <span class="fu">return</span> (<span class="dt">U</span> <span class="fu">$</span> \i <span class="ot">-&gt;</span> i))</a>
<a class="sourceLine" id="cb12-9" title="9">   <span class="co">-- Monad則(join . fmap return = id)</span></a>
<a class="sourceLine" id="cb12-10" title="10"> <span class="fu">=</span> <span class="dt">U</span> <span class="fu">$</span> \i <span class="ot">-&gt;</span> i</a>
<a class="sourceLine" id="cb12-11" title="11"></a>
<a class="sourceLine" id="cb12-12" title="12"><span class="fu">fmap</span> <span class="fu">snd</span> (join coord)</a>
<a class="sourceLine" id="cb12-13" title="13"> <span class="fu">=</span> join (<span class="fu">fmap</span> (<span class="fu">fmap</span> <span class="fu">snd</span>) coord)</a>
<a class="sourceLine" id="cb12-14" title="14"> <span class="fu">=</span> join (<span class="dt">U</span> <span class="fu">$</span> \i <span class="ot">-&gt;</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> j)</a>
<a class="sourceLine" id="cb12-15" title="15"> <span class="fu">=</span> join (<span class="fu">return</span> <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> j)</a>
<a class="sourceLine" id="cb12-16" title="16">   <span class="co">-- Monad則(join . return = id)</span></a>
<a class="sourceLine" id="cb12-17" title="17"> <span class="fu">=</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> j</a>
<a class="sourceLine" id="cb12-18" title="18"></a>
<a class="sourceLine" id="cb12-19" title="19">join coord <span class="fu">=</span> <span class="dt">U</span> <span class="fu">$</span> \i <span class="ot">-&gt;</span> (i,i)</a>
<a class="sourceLine" id="cb12-20" title="20"></a>
<a class="sourceLine" id="cb12-21" title="21">join <span class="fu">$</span> <span class="dt">U</span> (\i <span class="ot">-&gt;</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> a i j))</a>
<a class="sourceLine" id="cb12-22" title="22"> <span class="fu">=</span> join <span class="fu">$</span> <span class="fu">fmap</span> (<span class="fu">fmap</span> (<span class="fu">uncurry</span> a)) coord</a>
<a class="sourceLine" id="cb12-23" title="23"> <span class="fu">=</span> <span class="fu">fmap</span> (<span class="fu">uncurry</span> a) <span class="fu">$</span> join coord</a>
<a class="sourceLine" id="cb12-24" title="24"> <span class="fu">=</span> <span class="fu">fmap</span> (<span class="fu">uncurry</span> a) <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \i <span class="ot">-&gt;</span> (i,i)</a>
<a class="sourceLine" id="cb12-25" title="25"> <span class="fu">=</span> <span class="dt">U</span> <span class="fu">$</span> \i <span class="ot">-&gt;</span> a i i</a></code></pre></div>
<p>ここで、次の関数を考える。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1"><span class="ot">at ::</span> <span class="kw">forall</span> x<span class="fu">.</span> <span class="dt">N</span> <span class="ot">-&gt;</span> x <span class="ot">-&gt;</span> <span class="dt">F</span> x</a>
<a class="sourceLine" id="cb13-2" title="2">at i x <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> <span class="fu">return</span> x <span class="kw">else</span> zero)</a></code></pre></div>
<p>いま、ある<code>i :: N</code>において<code>at i x</code>が<code>x</code>に依存しないと仮定する。 このとき、次の<code>sweep f</code>は<code>f i</code>の値に依存しないはずである。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" title="1"><span class="ot">sweep ::</span> <span class="kw">forall</span> x<span class="fu">.</span> (<span class="dt">N</span> <span class="ot">-&gt;</span> x) <span class="ot">-&gt;</span> <span class="dt">F</span> (<span class="dt">F</span> x)</a>
<a class="sourceLine" id="cb14-2" title="2">sweep f <span class="fu">=</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> at j (f j)</a></code></pre></div>
<p>一方、<code>join $ sweep f</code>を<code>join</code>の結合則を用いて計算すると、以下のようになる。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" title="1">join <span class="fu">$</span> sweep f</a>
<a class="sourceLine" id="cb15-2" title="2"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> at j (f j))</a>
<a class="sourceLine" id="cb15-3" title="3"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> join <span class="fu">$</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> j <span class="fu">==</span> k <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero))</a>
<a class="sourceLine" id="cb15-4" title="4"> <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> j <span class="fu">==</span> k <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero))</a>
<a class="sourceLine" id="cb15-5" title="5"> <span class="co">-- 結合則</span></a>
<a class="sourceLine" id="cb15-6" title="6"> <span class="fu">=</span> join <span class="fu">.</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> j <span class="fu">==</span> k <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero))</a>
<a class="sourceLine" id="cb15-7" title="7"> <span class="co">-- joinUU</span></a>
<a class="sourceLine" id="cb15-8" title="8"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> j <span class="fu">==</span> j <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero)</a>
<a class="sourceLine" id="cb15-9" title="9"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="fu">return</span> (f j))</a>
<a class="sourceLine" id="cb15-10" title="10"> <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> <span class="fu">return</span> <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> f j)</a>
<a class="sourceLine" id="cb15-11" title="11"> <span class="co">-- 単位則</span></a>
<a class="sourceLine" id="cb15-12" title="12"> <span class="fu">=</span> <span class="dt">U</span> f</a></code></pre></div>
<p>これは明らかに<code>f</code>の任意の点<code>i :: N</code>での値に依存する。これは矛盾である。</p>
<ul>
<li><strong>事実1</strong>: 任意の<code>i</code>に対して<code>at i x</code>は<code>x</code>に依存する。</li>
</ul>
<p>次に、<code>at i /= return</code>を示す。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" title="1"><span class="dt">U</span> f <span class="fu">&gt;&gt;=</span> <span class="fu">return</span></a>
<a class="sourceLine" id="cb16-2" title="2"> <span class="fu">=</span> <span class="dt">U</span> f</a>
<a class="sourceLine" id="cb16-3" title="3"><span class="dt">U</span> f <span class="fu">&gt;&gt;=</span> at i</a>
<a class="sourceLine" id="cb16-4" title="4"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> at i (f j))</a>
<a class="sourceLine" id="cb16-5" title="5"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> join <span class="fu">$</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> k <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero))</a>
<a class="sourceLine" id="cb16-6" title="6"> <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> k <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero))</a>
<a class="sourceLine" id="cb16-7" title="7"> <span class="fu">=</span> join <span class="fu">.</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> k <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero))</a>
<a class="sourceLine" id="cb16-8" title="8"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero)</a>
<a class="sourceLine" id="cb16-9" title="9"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> <span class="fu">return</span> (f i) <span class="kw">else</span> zero)</a>
<a class="sourceLine" id="cb16-10" title="10"> <span class="fu">=</span> at i (f i)</a></code></pre></div>
<p>いま、<code>N</code>には2つ以上の異なる値があるので、<code>i' /= i</code>なる<code>i' :: N</code>が存在して、<code>U f</code>は<code>f i</code>にも<code>f i'</code>にも依存する。 しかし、<code>at i (f i)</code>は<code>f i</code>にしか依存しないので、<code>at i = return</code> ではありえない。</p>
<ul>
<li><strong>事実2</strong>: 任意の<code>i</code>に対して<code>at i /= return</code></li>
</ul>
<p>加えて、</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" title="1"><span class="ot">hole ::</span> (<span class="dt">N</span> <span class="ot">-&gt;</span> x) <span class="ot">-&gt;</span> <span class="dt">N</span> <span class="ot">-&gt;</span> (x <span class="ot">-&gt;</span> <span class="dt">F</span> x) <span class="ot">-&gt;</span> <span class="dt">F</span> x</a>
<a class="sourceLine" id="cb17-2" title="2">hole f i u <span class="fu">=</span> join <span class="fu">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> u (f j) <span class="kw">else</span> <span class="fu">return</span> (f j)</a>
<a class="sourceLine" id="cb17-3" title="3"></a>
<a class="sourceLine" id="cb17-4" title="4">hole f i (at k)</a>
<a class="sourceLine" id="cb17-5" title="5"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> at k (f j) <span class="kw">else</span> <span class="fu">return</span> (f j)</a>
<a class="sourceLine" id="cb17-6" title="6"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j</a>
<a class="sourceLine" id="cb17-7" title="7">     <span class="kw">then</span> join <span class="fu">$</span> <span class="dt">U</span> (\l <span class="ot">-&gt;</span> <span class="kw">if</span> k <span class="fu">==</span> l <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero)</a>
<a class="sourceLine" id="cb17-8" title="8">     <span class="kw">else</span> join <span class="fu">.</span> <span class="fu">return</span> <span class="fu">.</span> <span class="fu">return</span> <span class="fu">$</span> f j</a>
<a class="sourceLine" id="cb17-9" title="9"> <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j</a>
<a class="sourceLine" id="cb17-10" title="10">     <span class="kw">then</span> <span class="dt">U</span> (\l <span class="ot">-&gt;</span> <span class="kw">if</span> k <span class="fu">==</span> l <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero)</a>
<a class="sourceLine" id="cb17-11" title="11">     <span class="kw">else</span> <span class="dt">U</span> (\_ <span class="ot">-&gt;</span> <span class="fu">return</span> (f j))</a>
<a class="sourceLine" id="cb17-12" title="12"> <span class="co">-- 結合則 + joinUU</span></a>
<a class="sourceLine" id="cb17-13" title="13"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb17-14" title="14">     <span class="kw">if</span> i <span class="fu">==</span> j</a>
<a class="sourceLine" id="cb17-15" title="15">       <span class="kw">then</span> <span class="kw">if</span> k <span class="fu">==</span> j <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> zero</a>
<a class="sourceLine" id="cb17-16" title="16">       <span class="kw">else</span> <span class="fu">return</span> (f j)</a>
<a class="sourceLine" id="cb17-17" title="17"></a>
<a class="sourceLine" id="cb17-18" title="18"><span class="co">-- i == k のとき</span></a>
<a class="sourceLine" id="cb17-19" title="19">hole f i (at k) <span class="fu">|</span> i <span class="fu">==</span> k</a>
<a class="sourceLine" id="cb17-20" title="20"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> (i <span class="fu">==</span> j) <span class="kw">then</span> <span class="fu">return</span> (f j) <span class="kw">else</span> <span class="fu">return</span> (f j)</a>
<a class="sourceLine" id="cb17-21" title="21"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> <span class="fu">return</span> (f j)</a>
<a class="sourceLine" id="cb17-22" title="22"> <span class="fu">=</span> <span class="dt">U</span> f</a>
<a class="sourceLine" id="cb17-23" title="23"></a>
<a class="sourceLine" id="cb17-24" title="24"><span class="co">-- i /= k のとき</span></a>
<a class="sourceLine" id="cb17-25" title="25">hole f i (at k) <span class="fu">|</span> i <span class="fu">/=</span> k</a>
<a class="sourceLine" id="cb17-26" title="26"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb17-27" title="27">     <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> <span class="fu">return</span> (f j)</a></code></pre></div>
<p>より、<code>hole f i (at k)</code>が<code>f i</code>に依存するかどうかは、<code>i == k</code>かどうかによって決まる。したがって、<code>i /= k</code>のとき、<code>at i /= at k</code>である。</p>
<ul>
<li><strong>事実3</strong>: 任意の<code>i, k :: N</code>に対して、<code>i /= k</code>ならば<code>at i /= at k</code></li>
</ul>
<p>いま、<code>at i x</code>は<code>x</code>に依存するのであった。<code>return</code>のときと同様の議論によって、<code>at i x</code>が返すコンストラクタは2つ以上の<code>x</code>の値に依存することができるので、関数<code>con :: N -&gt; x -&gt; x -&gt; F x</code>が存在して、<code>con i x y</code>は<code>x</code>と<code>y</code>の両方に依存し、 <code>con i x x = at i x</code>となるようにできる。</p>
<p><code>con i</code>に関する等式をいくつか示す。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" title="1">join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> at i x)</a>
<a class="sourceLine" id="cb18-2" title="2"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> join (<span class="fu">return</span> zero) <span class="kw">else</span> join <span class="fu">$</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> k <span class="kw">then</span> <span class="fu">return</span> x <span class="kw">else</span> zero))</a>
<a class="sourceLine" id="cb18-3" title="3"> <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb18-4" title="4">     <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> <span class="fu">return</span> zero <span class="kw">else</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> k <span class="kw">then</span> <span class="fu">return</span> x <span class="kw">else</span> zero)</a>
<a class="sourceLine" id="cb18-5" title="5"> <span class="fu">=</span> join <span class="fu">.</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> <span class="dt">U</span> <span class="fu">$</span> \k <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb18-6" title="6">     <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> (<span class="kw">if</span> i <span class="fu">==</span> k <span class="kw">then</span> <span class="fu">return</span> x <span class="kw">else</span> zero)</a>
<a class="sourceLine" id="cb18-7" title="7"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb18-8" title="8">     <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> (<span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> <span class="fu">return</span> x <span class="kw">else</span> zero)</a>
<a class="sourceLine" id="cb18-9" title="9"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> zero</a>
<a class="sourceLine" id="cb18-10" title="10"> <span class="fu">=</span> join <span class="fu">$</span> <span class="fu">return</span> zero</a>
<a class="sourceLine" id="cb18-11" title="11"> <span class="fu">=</span> zero</a>
<a class="sourceLine" id="cb18-12" title="12"></a>
<a class="sourceLine" id="cb18-13" title="13"><span class="co">-- Because `join` can't discriminate between `at i x = con i x x` and `con i x y`:</span></a>
<a class="sourceLine" id="cb18-14" title="14">join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> con i x y)</a>
<a class="sourceLine" id="cb18-15" title="15"> <span class="fu">=</span> zero</a>
<a class="sourceLine" id="cb18-16" title="16"></a>
<a class="sourceLine" id="cb18-17" title="17">join <span class="fu">$</span> at i (con i x y)</a>
<a class="sourceLine" id="cb18-18" title="18"> <span class="fu">=</span> join <span class="fu">.</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> <span class="fu">return</span> (con i x y) <span class="kw">else</span> zero)</a>
<a class="sourceLine" id="cb18-19" title="19"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> join (<span class="fu">return</span> (con i x y)) <span class="kw">else</span> join zero)</a>
<a class="sourceLine" id="cb18-20" title="20"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> con i x y <span class="kw">else</span> zero)</a>
<a class="sourceLine" id="cb18-21" title="21">  <span class="co">-- Use above equation in reversed direction</span></a>
<a class="sourceLine" id="cb18-22" title="22"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb18-23" title="23">     <span class="kw">if</span> i <span class="fu">==</span> j</a>
<a class="sourceLine" id="cb18-24" title="24">       <span class="kw">then</span> con i x y</a>
<a class="sourceLine" id="cb18-25" title="25">       <span class="kw">else</span> join <span class="fu">$</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> k <span class="kw">then</span> zero <span class="kw">else</span> con i x y)</a>
<a class="sourceLine" id="cb18-26" title="26"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb18-27" title="27">     <span class="kw">if</span> i <span class="fu">==</span> j</a>
<a class="sourceLine" id="cb18-28" title="28">       <span class="kw">then</span> join <span class="fu">$</span> <span class="fu">return</span> (con i x y)</a>
<a class="sourceLine" id="cb18-29" title="29">       <span class="kw">else</span> join <span class="fu">$</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> k <span class="kw">then</span> zero <span class="kw">else</span> con i x y)</a>
<a class="sourceLine" id="cb18-30" title="30"> <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> <span class="dt">U</span> <span class="fu">$</span> \k <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb18-31" title="31">     <span class="kw">if</span> i <span class="fu">==</span> j</a>
<a class="sourceLine" id="cb18-32" title="32">       <span class="kw">then</span> con i x y</a>
<a class="sourceLine" id="cb18-33" title="33">       <span class="kw">else</span> (<span class="kw">if</span> i <span class="fu">==</span> k <span class="kw">then</span> zero <span class="kw">else</span> con i x y)</a>
<a class="sourceLine" id="cb18-34" title="34"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb18-35" title="35">     <span class="kw">if</span> i <span class="fu">==</span> j</a>
<a class="sourceLine" id="cb18-36" title="36">       <span class="kw">then</span> con i x y</a>
<a class="sourceLine" id="cb18-37" title="37">       <span class="kw">else</span> (<span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> zero <span class="kw">else</span> con i x y)</a>
<a class="sourceLine" id="cb18-38" title="38"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> con i x y</a>
<a class="sourceLine" id="cb18-39" title="39"> <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">return</span> <span class="fu">$</span> con i x y</a>
<a class="sourceLine" id="cb18-40" title="40"> <span class="fu">=</span> con i x y</a></code></pre></div>
<p>いま、次の関数<code>extra</code>を考える。</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb19-1" title="1"><span class="ot">extra ::</span> <span class="kw">forall</span> x<span class="fu">.</span> <span class="dt">N</span> <span class="ot">-&gt;</span> x <span class="ot">-&gt;</span> x <span class="ot">-&gt;</span> (<span class="dt">N</span> <span class="ot">-&gt;</span> x) <span class="ot">-&gt;</span> <span class="dt">F</span> x</a>
<a class="sourceLine" id="cb19-2" title="2">extra i x y f <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> con i x y <span class="kw">else</span> <span class="fu">return</span> (f j))</a></code></pre></div>
<p>次の計算によって、2つのことがわかる。</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb20-1" title="1">extra i (f i) (f i) f</a>
<a class="sourceLine" id="cb20-2" title="2"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> con i (f i) (f i) <span class="kw">else</span> <span class="fu">return</span> (f j))</a>
<a class="sourceLine" id="cb20-3" title="3"> <span class="fu">=</span> join <span class="fu">$</span> <span class="dt">U</span> (\j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> at i (f i) <span class="kw">else</span> <span class="fu">return</span> (f j))</a>
<a class="sourceLine" id="cb20-4" title="4"> <span class="fu">=</span> hole f i (at i)</a>
<a class="sourceLine" id="cb20-5" title="5"> <span class="fu">=</span> <span class="dt">U</span> f</a></code></pre></div>
<p>まず、<code>extra</code>は<code>x</code>に関して自然なので、任意の<code>x, y, f</code>に関して<code>extra i x y f = U _</code>とならなければならない。 また、<code>extra i x y f</code>は任意の<code>j /= i</code>における<code>f j</code>と、<code>x</code>, <code>y</code>のいずれか片方に依存する。</p>
<p>さらに、</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" title="1">join <span class="fu">$</span> at i (extra i x y f)</a>
<a class="sourceLine" id="cb21-2" title="2"> <span class="fu">=</span> join <span class="fu">.</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> extra i x y f <span class="kw">else</span> zero</a>
<a class="sourceLine" id="cb21-3" title="3"> <span class="fu">=</span> join <span class="fu">.</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb21-4" title="4">     <span class="kw">if</span> i <span class="fu">==</span> j</a>
<a class="sourceLine" id="cb21-5" title="5">       <span class="kw">then</span> join <span class="fu">$</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> k <span class="kw">then</span> con i x y <span class="kw">else</span> <span class="fu">return</span> (f k))</a>
<a class="sourceLine" id="cb21-6" title="6">       <span class="kw">else</span> join (<span class="fu">return</span> zero)</a>
<a class="sourceLine" id="cb21-7" title="7"> <span class="fu">=</span> join <span class="fu">.</span> join <span class="fu">.</span> <span class="fu">fmap</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb21-8" title="8">     <span class="kw">if</span> i <span class="fu">==</span> j</a>
<a class="sourceLine" id="cb21-9" title="9">       <span class="kw">then</span> <span class="dt">U</span> (\k <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> k <span class="kw">then</span> con i x y <span class="kw">else</span> <span class="fu">return</span> (f k))</a>
<a class="sourceLine" id="cb21-10" title="10">       <span class="kw">else</span> <span class="fu">return</span> zero</a>
<a class="sourceLine" id="cb21-11" title="11"> <span class="fu">=</span> join <span class="fu">.</span> join <span class="fu">.</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> <span class="dt">U</span> <span class="fu">$</span> \k <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb21-12" title="12">     <span class="kw">if</span> i <span class="fu">==</span> j</a>
<a class="sourceLine" id="cb21-13" title="13">       <span class="kw">then</span> <span class="kw">if</span> i <span class="fu">==</span> k <span class="kw">then</span> con i x y <span class="kw">else</span> <span class="fu">return</span> (f k)</a>
<a class="sourceLine" id="cb21-14" title="14">       <span class="kw">else</span> zero</a>
<a class="sourceLine" id="cb21-15" title="15"> <span class="fu">=</span> join <span class="fu">.</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb21-16" title="16">     <span class="kw">if</span> i <span class="fu">==</span> j</a>
<a class="sourceLine" id="cb21-17" title="17">       <span class="kw">then</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> con i x y <span class="kw">else</span> <span class="fu">return</span> (f j)</a>
<a class="sourceLine" id="cb21-18" title="18">       <span class="kw">else</span> zero</a>
<a class="sourceLine" id="cb21-19" title="19"> <span class="fu">=</span> join <span class="fu">.</span> join <span class="fu">$</span> <span class="dt">U</span> <span class="fu">$</span> \j <span class="ot">-&gt;</span> <span class="kw">if</span> i <span class="fu">==</span> j <span class="kw">then</span> con i x y <span class="kw">else</span> zero</a>
<a class="sourceLine" id="cb21-20" title="20"> <span class="fu">=</span> join <span class="fu">$</span> at i (con i x y)</a>
<a class="sourceLine" id="cb21-21" title="21"> <span class="fu">=</span> con i x y</a></code></pre></div>
<p>である。したがって、<code>extra i x y f</code>は<code>x</code>と<code>y</code>の両方に依存する。</p>
<p>さて、<code>extra i x y f = U g</code>と書くことができ、<code>g :: N -&gt; x</code>なのであった。<code>g</code>は任意の<code>j /= i</code>における<code>f j</code>、<code>x</code>、そして<code>y</code>のいずれにも依存する。しかし、<code>N</code>が有限であればこれは<code>N+1</code>個の独立な変数なので、これは不可能である。</p>
<ul>
<li><strong>事実4</strong>: <code>N</code>は無限個の異なる値をとる。</li>
</ul>
<p>さらに、<code>at i</code>は各<code>i</code>について異なる必要があるので、</p>
<ul>
<li><strong>事実5</strong>: <code>F(x)</code>は無限個の項の和である。</li>
</ul>
<p>いま、多項式Functorは、有限な型<code>a_i</code>について<code>x^(a_i)</code>の有限個の直和型として定義したのであった。よって、ここで定義した<code>F(x)</code>は<code>Monad</code>になることはない。</p>
    </section>
</article>

        </main>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
    </body>
</html>
