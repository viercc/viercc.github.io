<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Too lazy to evaluate - ネットワークのトラブルシューティング</title>
        <link rel="stylesheet" href="../css/syntax.css" />
        <link rel="stylesheet" href="../css/default.css" />
        
        
    </head>
    <body>
        <header>
            <div class="logo">
                <a href="../">Too lazy to evaluate</a>
            </div>
            <nav>
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </nav>
        </header>

        <main role="main">
            <h1>ネットワークのトラブルシューティング</h1>
            <article>
    <section class="header">
        
            Posted on 2020-09-02
        
        
    </section>
    <section>
        <p>（自宅のネットワーク環境でトラブったのでメモ代わりにここに記録します）</p>
<h2 id="現象">現象</h2>
<ul>
<li>自宅のネットワーク機器のうち、Ubuntu 20.04をインストールしていた2台のPCだけが、30~60分で通信できなくなった。
<ul>
<li>Ubuntu 20.04の機器はこの2台以外にはなかった。</li>
<li>クリーンインストールしても発生した</li>
<li>Windows10とデュアルブートしていた機器では、Windows10を動作させているときにこの現象はなかった</li>
</ul></li>
<li>自宅のインターネット回線は<a href="https://www.au.com/okinawa_cellular/hikari/">auひかり ちゅら</a>であり、借りているHGW(AtermBL900HW)にWifiまたは有線のEthernetで接続していた
<ul>
<li>Wifiでも有線でも、この現象は必ず発生した</li>
</ul></li>
<li>通信できなくなる直接の原因は、PCが（HGWから）DHCPで配布してもらっていたIPv4アドレスの更新に失敗するため
<ul>
<li>切断→再接続で復帰していた</li>
<li>パケットをキャプチャしたところ、この現象が発生していたPCでもHGW上のDHCPサーバからDHCPACKパケットを受信できていた ⇒ DHCPクライアントの問題が想定できる</li>
</ul></li>
</ul>
<h2 id="解決方法">解決方法</h2>
<ul>
<li>Ubuntu20.04(デスクトップ向け)のネットワーク関係の設定は、デフォルトの状態では、<a href="http://manpages.ubuntu.com/manpages/focal/man8/NetworkManager.8.html">NetworkManager</a>デーモンが管理している。以下、「デフォルトでは」は省略する。</li>
<li>NetworkManagerは、DHCPクライアントとしてNetworkManagerに組み込みのDHCPクライアント機能を使用する。</li>
<li>組み込みのDHCPクライアント機能に代わって、<a href="http://manpages.ubuntu.com/manpages/focal/en/man8/dhclient.8.html">dhclient</a>を使用するように設定すると、この現象は発生しなくなった。
<ul>
<li><p>設定には、<code>/etc/NetworkManager/NetworkManager.conf</code>に次の行を追加した。</p>
<pre><code>[main]
plugins=ifupdown,keyfile
# この行を追加した
dhcp=dhclient

[ifupdown]
managed=false</code></pre></li>
<li><p>組み込みのDHCPクライアント機能でこの現象が発生した理由は不明</p>
<ul>
<li>以下推測
<ul>
<li>このHGWは、同一MACアドレスからの頻繁な<code>DHCPREQUEST/DISCOVER</code>に対して、ある一定以下の頻度(15〜30分程度)でしか<code>DHCPACK/OFFER</code>を返さない
<ul>
<li>まあ理解できる</li>
</ul></li>
<li>組み込みのDHCPクライアントは、DHCPサーバからの応答を待つ時間・応答がない場合にリクエストを再送するまでの時間ともに短い
<ul>
<li>理解できる</li>
<li>しかしその設定を変更する方法がわからない。NetworkManagerを自分でコンパイルする以外無理？</li>
</ul></li>
<li>組み込みのDHCPクライアントは、大多数の<code>DHCPREQUEST</code>が無視される環境で機能しない
<ul>
<li>なんで？？？？？？？？</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
    </section>
</article>

        </main>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
    </body>
</html>
