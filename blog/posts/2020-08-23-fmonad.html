<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Too lazy to evaluate - Functor上のモナド、FMonadについて</title>
        <link rel="stylesheet" href="../css/syntax.css" />
        <link rel="stylesheet" href="../css/default.css" />
    </head>
    <body>
        <header>
            <div class="logo">
                <a href="../">Too lazy to evaluate</a>
            </div>
            <nav>
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </nav>
        </header>

        <main role="main">
            <h1>Functor上のモナド、FMonadについて</h1>
            <article>
    <section class="header">
        Posted on August 23, 2020
        
    </section>
    <section>
        <h1 id="モナドはmonad以外にもある">モナドは<code>Monad</code>以外にもある</h1>
<p>この記事では、「モナド」と「<code>Monad</code>」とを違う意味の言葉として使いわけます。 <a href="https://ja.wikipedia.org/wiki/%E3%83%A2%E3%83%8A%E3%83%89_(%E5%9C%8F%E8%AB%96)">モナド (圏論)</a>のうち、 ある特殊な場合が<code>Monad</code>である、とします。</p>
<p>詳しい説明はここではしませんが、 次の<code>FMonad</code>は、「モナドだけど<code>Monad</code>じゃない」 性質を表す型クラスです。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="co">-- | Natural</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">type</span> (<span class="fu">~&gt;</span>) f g <span class="fu">=</span> <span class="kw">forall</span> x<span class="fu">.</span> f x <span class="ot">-&gt;</span> g x</a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co">-- | Functor on Functors</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">class</span> (<span class="kw">forall</span> g<span class="fu">.</span> <span class="dt">Functor</span> g <span class="ot">=&gt;</span> <span class="dt">Functor</span> (ff g)) <span class="ot">=&gt;</span> <span class="dt">FFunctor</span> ff <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="ot">    ffmap ::</span> (<span class="dt">Functor</span> g, <span class="dt">Functor</span> h) <span class="ot">=&gt;</span> (g <span class="fu">~&gt;</span> h) <span class="ot">-&gt;</span> (ff g <span class="fu">~&gt;</span> ff h)</a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co">-- | Monad on Functors</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">class</span> <span class="dt">FFunctor</span> ff <span class="ot">=&gt;</span> <span class="dt">FMonad</span> ff <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="ot">    fpure ::</span> (<span class="dt">Functor</span> g) <span class="ot">=&gt;</span> g <span class="fu">~&gt;</span> ff g</a>
<a class="sourceLine" id="cb1-11" title="11"><span class="ot">    fjoin ::</span> (<span class="dt">Functor</span> g) <span class="ot">=&gt;</span> ff (ff g) <span class="fu">~&gt;</span> ff g</a></code></pre></div>
<p><code>FFunctor</code>と<code>FMonad</code>は、 <code>Functor</code>と<code>Monad</code>によく似ていることがわかります。 さらに、<code>FFunctor</code>則と<code>FMonad</code>則も<code>Functor</code>、<code>Monad</code>のものにそっくりです。 これらをまとめて抽象化できるのが、一般的なほうの「モナド」です。</p>
<pre><code>FFunctor laws:
    ffmap id = id
    ffmap f . ffmap g = ffmap (f . g)

FMonad laws:
[fpure is natural in g]
    ∀(n :: g ~&gt; h). ffmap n . fpure = fpure . n

[fjoin is natural in g]
    ∀(n :: g ~&gt; h). ffmap n . fjoin = fjoin . ffmap (ffmap n)

[Left unit]
    fjoin . fpure = id

[Right unit]
    fjoin . fmap fpure = id

[Associativity]
    fjoin . fjoin = fjoin . ffmap fjoin</code></pre>
<h2 id="具体例1readert-e">具体例1:<code>ReaderT e</code></h2>
<p><code>ReaderT e</code>は<code>FFunctor</code>かつ<code>FMonad</code>になります。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">newtype</span> <span class="dt">ReadeT</span> e m a <span class="fu">=</span> <span class="dt">ReaderT</span> {<span class="ot"> runReaderT ::</span> e <span class="ot">-&gt;</span> m a }</a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">instance</span> <span class="dt">Functor</span> m     <span class="ot">=&gt;</span> <span class="dt">Functor</span> (<span class="dt">ReaderT</span> e m)</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">instance</span> <span class="dt">Applicative</span> m <span class="ot">=&gt;</span> <span class="dt">Applicative</span> (<span class="dt">ReaderT</span> e m)</a>
<a class="sourceLine" id="cb3-5" title="5"><span class="kw">instance</span> <span class="dt">Monad</span> m       <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">ReaderT</span> e m)</a></code></pre></div>
<p>これが、次のように<code>FFunctor, FMonad</code>になります。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">instance</span> <span class="dt">FFunctor</span> (<span class="dt">ReaderT</span> e) <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="ot">    ffmap ::</span> (<span class="dt">Functor</span> f, <span class="dt">Functor</span> g) <span class="ot">=&gt;</span> (f <span class="fu">~&gt;</span> g) <span class="ot">-&gt;</span> (<span class="dt">ReaderT</span> e f <span class="fu">~&gt;</span> <span class="dt">ReaderT</span> e g)</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="co">{-  ffmap :: (Functor f, Functor g)</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="co">          =&gt; (forall x. f x -&gt; g x) -&gt; (forall y. ReaderT e f y -&gt; ReaderT e g y)  -}</span></a>
<a class="sourceLine" id="cb4-5" title="5">    ffmap fg my <span class="fu">=</span> <span class="dt">ReaderT</span> <span class="fu">.</span> <span class="fu">fmap</span> fg <span class="fu">.</span> runReaderT</a>
<a class="sourceLine" id="cb4-6" title="6"></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="kw">instance</span> <span class="dt">FMonad</span> (<span class="dt">ReaderT</span> e) <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="ot">    fpure ::</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> f <span class="fu">~&gt;</span> <span class="dt">ReaderT</span> e f</a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co">{-  fpure :: f x -&gt; ReaderT e f x  -}</span></a>
<a class="sourceLine" id="cb4-10" title="10">    fpure <span class="fu">=</span> <span class="dt">ReaderT</span> <span class="fu">.</span> (<span class="fu">return</span><span class="ot"> ::</span> f x <span class="ot">-&gt;</span> (e <span class="ot">-&gt;</span> f x))</a>
<a class="sourceLine" id="cb4-11" title="11"></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="ot">    fjoin ::</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">ReaderT</span> e (<span class="dt">ReaderT</span> e f) <span class="fu">~&gt;</span> <span class="dt">ReaderT</span> e f</a>
<a class="sourceLine" id="cb4-13" title="13">    fjoin <span class="fu">=</span> <span class="dt">ReaderT</span> <span class="fu">.</span> (<span class="ot">join ::</span> (e <span class="ot">-&gt;</span> e <span class="ot">-&gt;</span> f x) <span class="ot">-&gt;</span> e <span class="ot">-&gt;</span> f x) <span class="fu">.</span> <span class="fu">fmap</span> runReaderT <span class="fu">.</span> runReaderT</a></code></pre></div>
<p><code>ReaderT e f x</code> は、<code>newtype</code>を外せば <code>e -&gt; f x</code> で、これは <code>Monad</code>である<code>(e -&gt; _)</code> と、<code>Monad</code>とは限らない <code>f</code> の合成Functorと見ることができます。 <code>m ~ ((-&gt;) e)</code>とおけば、<code>fpure</code>は<code>return</code>で<code>f x</code>を包んで<code>m (f x)</code>にして、 <code>fjoin</code>は<code>join</code>で<code>m (m (f x))</code>を潰して<code>m (f x)</code>にしているだけです。</p>
<p>一般化すれば、Functorの合成（<a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Data-Functor-Compose.html">Data.Functor.Compose</a>）に対して、次のインスタンスが作れます。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">instance</span> <span class="dt">Functor</span> m <span class="ot">=&gt;</span> <span class="dt">FFunctor</span> (<span class="dt">Compose</span> m)</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw">instance</span> <span class="dt">Monad</span> m   <span class="ot">=&gt;</span> <span class="dt">FMonad</span> (<span class="dt">Compose</span> m)</a></code></pre></div>
<h2 id="具体例2writert-w">具体例2:<code>WriterT w</code></h2>
<p><code>WriterT w</code>も<code>FFunctor</code>かつ<code>FMonad</code>になります。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">newtype</span> <span class="dt">WriterT</span> w m a <span class="fu">=</span> <span class="dt">WriterT</span> {<span class="ot"> runWriterT ::</span> m (a, w) }</a>
<a class="sourceLine" id="cb6-2" title="2"></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="kw">instance</span> <span class="dt">Functor</span> m     <span class="ot">=&gt;</span> <span class="dt">Functor</span> (<span class="dt">WriterT</span> e m)</a>
<a class="sourceLine" id="cb6-4" title="4"><span class="kw">instance</span> <span class="dt">Applicative</span> m <span class="ot">=&gt;</span> <span class="dt">Applicative</span> (<span class="dt">WriterT</span> e m)</a>
<a class="sourceLine" id="cb6-5" title="5"><span class="kw">instance</span> <span class="dt">Monad</span> m       <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">WriterT</span> e m)</a>
<a class="sourceLine" id="cb6-6" title="6"></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="kw">instance</span> <span class="dt">FFunctor</span> (<span class="dt">WriterT</span> w) <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-8" title="8">    ffmap fg <span class="fu">=</span> <span class="dt">WriterT</span> <span class="fu">.</span> fg <span class="fu">.</span> runWriterT</a>
<a class="sourceLine" id="cb6-9" title="9"></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="kw">instance</span> (<span class="dt">Monoid</span> w) <span class="ot">=&gt;</span> <span class="dt">FMonad</span> (<span class="dt">WriterT</span> w) <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="ot">    fpure ::</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> f <span class="fu">~&gt;</span> <span class="dt">WriterT</span> w f</a>
<a class="sourceLine" id="cb6-12" title="12">    fpure <span class="fu">=</span> <span class="dt">WriterT</span> <span class="fu">.</span> <span class="fu">fmap</span> returnWriter</a>
<a class="sourceLine" id="cb6-13" title="13">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-14" title="14">        returnWriter x <span class="fu">=</span> (x, <span class="fu">mempty</span>)</a>
<a class="sourceLine" id="cb6-15" title="15">        <span class="co">-- return x = Writer (x, mempty) :: Writer w x</span></a>
<a class="sourceLine" id="cb6-16" title="16">    </a>
<a class="sourceLine" id="cb6-17" title="17"><span class="ot">    fjoin ::</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">WriterT</span> w (<span class="dt">WriterT</span> w f) <span class="fu">~&gt;</span> <span class="dt">WriterT</span> w f</a>
<a class="sourceLine" id="cb6-18" title="18">    fjoin <span class="fu">=</span> <span class="dt">WriterT</span> <span class="fu">.</span> <span class="fu">fmap</span> joinWriter <span class="fu">.</span> runWriterT <span class="fu">.</span> runWriterT</a>
<a class="sourceLine" id="cb6-19" title="19">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-20" title="20">        joinWriter ((x,w2),w1) <span class="fu">=</span> (x, w1 <span class="fu">&lt;&gt;</span> w2)</a>
<a class="sourceLine" id="cb6-21" title="21">        <span class="co">-- join (Writer (Writer (x, w2), w1)) = Writer (x, w1 &lt;&gt; w2)</span></a></code></pre></div>
<p>1つめの例と同じように、これは任意の<code>Monad m</code>に拡張できて、 内側に<code>Monad m</code>を合成する<code>(`Compose` m)</code>は、 <code>FMonad</code>になります。</p>
<p>ただし、Haskellは<code>(`Compose` m)</code>のような型を作れないので、 それ用の新しい型を定義する必要があります。</p>
<pre><code>newtype FlipCompose m f a = FlipCompose { getFlipCompose :: f (m a) }

instance (Functor m, Functor f) =&gt; Functor (FlipCompose m f)
instance (Functor m) =&gt; FFunctor (FlipCompose m)
instance (Monad m)   =&gt; FMonad (FlipCompose m)</code></pre>
<h2 id="具体例3sum-f">具体例3:<code>Sum f</code></h2>
<p>これまでMonad Transformerばかりでしたが、<code>FMonad</code>がそうしたものに限られるわけではありません。 <code>Sum f</code>（<a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Data-Functor-Sum.html">Data.Functor.Sum</a>）は<code>FMonad</code>です。これは、Monad Transformerでないどころか、<code>Monad</code>とは何の関係もありません。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">data</span> <span class="dt">Sum</span> f g a <span class="fu">=</span> <span class="dt">InL</span> (f a) <span class="fu">|</span> <span class="dt">InR</span> (g a)</a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="kw">instance</span> (<span class="dt">Functor</span> f, <span class="dt">Functor</span> g) <span class="ot">=&gt;</span> <span class="dt">Functor</span> (<span class="dt">Sum</span> f g)</a></code></pre></div>
<p>その<code>FMonad</code>のインスタンスは、<code>Either</code>の<code>Monad</code>インスタンスとほぼ同じです。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">instance</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">FFunctor</span> (<span class="dt">Sum</span> f) <span class="kw">where</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="ot">    ffmap ::</span> (<span class="dt">Functor</span> g, <span class="dt">Functor</span> h) <span class="ot">=&gt;</span> (g <span class="fu">~&gt;</span> h) <span class="ot">-&gt;</span> (<span class="dt">Sum</span> f g <span class="fu">~&gt;</span> <span class="dt">Sum</span> f h)</a>
<a class="sourceLine" id="cb9-3" title="3">    ffmap _  (<span class="dt">InL</span> fx) <span class="fu">=</span> <span class="dt">InL</span> fx</a>
<a class="sourceLine" id="cb9-4" title="4">    ffmap gh (<span class="dt">InR</span> gx) <span class="fu">=</span> <span class="dt">InR</span> (gh gx)</a>
<a class="sourceLine" id="cb9-5" title="5"></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="kw">instance</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">FMonad</span> (<span class="dt">Sum</span> f) <span class="kw">where</span></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="ot">    fpure ::</span> (<span class="dt">Functor</span> g) <span class="ot">=&gt;</span> g <span class="fu">~&gt;</span> <span class="dt">Sum</span> f g</a>
<a class="sourceLine" id="cb9-8" title="8">    fpure <span class="fu">=</span> <span class="dt">InR</span></a>
<a class="sourceLine" id="cb9-9" title="9">    </a>
<a class="sourceLine" id="cb9-10" title="10"><span class="ot">    fjoin ::</span> (<span class="dt">Functor</span> g) <span class="ot">=&gt;</span> <span class="dt">Sum</span> f (<span class="dt">Sum</span> f g) <span class="fu">~&gt;</span> <span class="dt">Sum</span> f g</a>
<a class="sourceLine" id="cb9-11" title="11">    fjoin (<span class="dt">InL</span> fx)       <span class="fu">=</span> <span class="dt">InL</span> fx</a>
<a class="sourceLine" id="cb9-12" title="12">    fjoin (<span class="dt">InR</span> (<span class="dt">InL</span> fx)) <span class="fu">=</span> <span class="dt">InL</span> fx</a>
<a class="sourceLine" id="cb9-13" title="13">    fjoin (<span class="dt">InR</span> (<span class="dt">InR</span> gx)) <span class="fu">=</span> <span class="dt">InR</span> gx</a></code></pre></div>
<h2 id="具体例4free-f">具体例4:<code>Free f</code></h2>
<p>Free Monad（<a href="https://hackage.haskell.org/package/free-5.1.3/docs/Control-Monad-Free.html#t:Free">Free</a>）は<code>FMonad</code>です。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">data</span> <span class="dt">Free</span> f a <span class="fu">=</span> <span class="dt">Pure</span> a <span class="fu">|</span> <span class="dt">Free</span> (f (<span class="dt">Free</span> f a))</a>
<a class="sourceLine" id="cb10-2" title="2"></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="kw">instance</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">Functor</span> (<span class="dt">Free</span> f)</a>
<a class="sourceLine" id="cb10-4" title="4"><span class="kw">instance</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">Applicative</span> (<span class="dt">Free</span> f)</a>
<a class="sourceLine" id="cb10-5" title="5"><span class="kw">instance</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">Free</span> f) <span class="kw">where</span></a>
<a class="sourceLine" id="cb10-6" title="6">  <span class="fu">return</span> <span class="fu">=</span> <span class="dt">Pure</span></a>
<a class="sourceLine" id="cb10-7" title="7">  <span class="dt">Pure</span> a   <span class="fu">&gt;&gt;=</span> k <span class="fu">=</span> k a</a>
<a class="sourceLine" id="cb10-8" title="8">  <span class="dt">Free</span> fma <span class="fu">&gt;&gt;=</span> k <span class="fu">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> (<span class="fu">&gt;&gt;=</span> k) fma)</a>
<a class="sourceLine" id="cb10-9" title="9"></a>
<a class="sourceLine" id="cb10-10" title="10"><span class="kw">instance</span> <span class="dt">FFunctor</span> <span class="dt">Free</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb10-11" title="11">    ffmap <span class="fu">=</span> hoistFree</a>
<a class="sourceLine" id="cb10-12" title="12"></a>
<a class="sourceLine" id="cb10-13" title="13"><span class="kw">instance</span> <span class="dt">FMonad</span> <span class="dt">Free</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb10-14" title="14">    fpure <span class="fu">=</span> liftF</a>
<a class="sourceLine" id="cb10-15" title="15">    fjoin <span class="fu">=</span> foldFree <span class="fu">id</span></a>
<a class="sourceLine" id="cb10-16" title="16"></a>
<a class="sourceLine" id="cb10-17" title="17"><span class="co">-- これらはControl.Monad.Freeにある関数ですが、</span></a>
<a class="sourceLine" id="cb10-18" title="18"><span class="co">-- 参照しやすさのためにここにコピペします</span></a>
<a class="sourceLine" id="cb10-19" title="19"></a>
<a class="sourceLine" id="cb10-20" title="20"><span class="co">-- | The very definition of a free monad is that given a natural transformation you get a monad homomorphism.</span></a>
<a class="sourceLine" id="cb10-21" title="21"><span class="ot">foldFree ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> (<span class="kw">forall</span> x <span class="fu">.</span> f x <span class="ot">-&gt;</span> m x) <span class="ot">-&gt;</span> <span class="dt">Free</span> f a <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb10-22" title="22">foldFree _ (<span class="dt">Pure</span> a)  <span class="fu">=</span> <span class="fu">return</span> a</a>
<a class="sourceLine" id="cb10-23" title="23">foldFree f (<span class="dt">Free</span> as) <span class="fu">=</span> f as <span class="fu">&gt;&gt;=</span> foldFree f</a>
<a class="sourceLine" id="cb10-24" title="24"></a>
<a class="sourceLine" id="cb10-25" title="25"><span class="ot">hoistFree ::</span> (<span class="dt">Functor</span> g) <span class="ot">=&gt;</span> (f <span class="fu">~&gt;</span> g) <span class="ot">-&gt;</span> (<span class="dt">Free</span> f <span class="fu">~&gt;</span> <span class="dt">Free</span> g)</a>
<a class="sourceLine" id="cb10-26" title="26">hoistFree fg <span class="fu">=</span> go</a>
<a class="sourceLine" id="cb10-27" title="27">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb10-28" title="28">    go (<span class="dt">Pure</span> x)   <span class="fu">=</span> <span class="dt">Pure</span> x</a>
<a class="sourceLine" id="cb10-29" title="29">    go (<span class="dt">Free</span> fmx) <span class="fu">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> go (fg fmx))</a>
<a class="sourceLine" id="cb10-30" title="30"></a>
<a class="sourceLine" id="cb10-31" title="31"><span class="ot">liftF ::</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> f <span class="fu">~&gt;</span> <span class="dt">Free</span> f</a>
<a class="sourceLine" id="cb10-32" title="32">liftF fx <span class="fu">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> <span class="dt">Pure</span> fx)</a></code></pre></div>
<p>ここまでの例では省略してきましたが、<code>FFunctor</code>則・<code>FMonad</code>則も証明していきたいと思います。 その前に、次の有用な事実を確認しておきます: 任意の<code>Functor f, Monad n</code>および<code>t :: f ~&gt; n</code>に対して、</p>
<ol type="1">
<li><code>foldFree t . liftF = t</code></li>
<li><code>foldFree t</code>は<code>Monad</code>準同型</li>
<li>条件1.と2.を満たすような<code>Monad</code>準同型は<code>foldFree t</code>ただ一つだけ存在する</li>
</ol>
<p>ここで、<code>ft</code>が<code>Monad</code>準同型であるとは、次の条件を満たすことをいいます。</p>
<ul>
<li><code>ft . return = ft</code></li>
<li><code>ft . join = join . fmap ft . ft</code>
<ul>
<li><p>あるいは、これと同値な</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1">  ft <span class="fu">$</span> <span class="kw">do</span> x <span class="ot">&lt;-</span> mx</a>
<a class="sourceLine" id="cb11-2" title="2">         k x</a>
<a class="sourceLine" id="cb11-3" title="3"><span class="fu">=</span></a>
<a class="sourceLine" id="cb11-4" title="4">  <span class="kw">do</span> x <span class="ot">&lt;-</span> ft mx</a>
<a class="sourceLine" id="cb11-5" title="5">     ft (k x)</a></code></pre></div></li>
</ul></li>
</ul>
<p><strong><code>foldFree t . liftF = t</code></strong></p>
<p>これは定義を展開していけばすぐです。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" title="1">foldFree t <span class="fu">.</span> liftF</a>
<a class="sourceLine" id="cb12-2" title="2"> <span class="fu">=</span> foldFree t <span class="fu">.</span> <span class="dt">Free</span> <span class="fu">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span></a>
<a class="sourceLine" id="cb12-3" title="3"> <span class="fu">=</span> (<span class="fu">&gt;&gt;=</span> foldFree t) <span class="fu">.</span> t <span class="fu">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span></a>
<a class="sourceLine" id="cb12-4" title="4"> <span class="fu">=</span> (<span class="fu">&gt;&gt;=</span> foldFree t) <span class="fu">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span> <span class="fu">.</span> t</a>
<a class="sourceLine" id="cb12-5" title="5"> <span class="fu">=</span> (<span class="fu">&gt;&gt;=</span> foldFree t <span class="fu">.</span> <span class="dt">Pure</span>) <span class="fu">.</span> t</a>
<a class="sourceLine" id="cb12-6" title="6"> <span class="fu">=</span> (<span class="fu">&gt;&gt;=</span> <span class="fu">return</span>) <span class="fu">.</span> t</a>
<a class="sourceLine" id="cb12-7" title="7"> <span class="fu">=</span> t</a></code></pre></div>
<p><strong><code>foldFree t</code>は<code>Monad</code>準同型</strong></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1">foldFree t <span class="fu">.</span> <span class="fu">return</span></a>
<a class="sourceLine" id="cb13-2" title="2"> <span class="fu">=</span> foldFree t <span class="fu">.</span> <span class="dt">Pure</span></a>
<a class="sourceLine" id="cb13-3" title="3"> <span class="fu">=</span> <span class="fu">return</span></a>
<a class="sourceLine" id="cb13-4" title="4"></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="co">-- 次式を示したい</span></a>
<a class="sourceLine" id="cb13-6" title="6">foldFree t <span class="fu">.</span> join <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> (foldFree t) <span class="fu">.</span> foldFree t</a>
<a class="sourceLine" id="cb13-7" title="7"></a>
<a class="sourceLine" id="cb13-8" title="8">lhs mma <span class="fu">=</span> foldFree t <span class="fu">$</span> join mma</a>
<a class="sourceLine" id="cb13-9" title="9">rhs mma <span class="fu">=</span> join <span class="fu">.</span> foldFree t <span class="fu">.</span> foldFree t <span class="fu">$</span> mma</a>
<a class="sourceLine" id="cb13-10" title="10"></a>
<a class="sourceLine" id="cb13-11" title="11">lhs mma</a>
<a class="sourceLine" id="cb13-12" title="12"> <span class="fu">=</span> <span class="kw">case</span> mma <span class="kw">of</span></a>
<a class="sourceLine" id="cb13-13" title="13">     <span class="dt">Pure</span> ma   <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb13-14" title="14">       foldFree t <span class="fu">$</span> join (<span class="dt">Pure</span> ma)</a>
<a class="sourceLine" id="cb13-15" title="15">        <span class="fu">=</span> t ma</a>
<a class="sourceLine" id="cb13-16" title="16">     <span class="dt">Free</span> fmma <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb13-17" title="17">       foldFree t <span class="fu">$</span> join (<span class="dt">Free</span> fmma)</a>
<a class="sourceLine" id="cb13-18" title="18">        <span class="fu">=</span> foldFree t <span class="fu">$</span> <span class="dt">Free</span> (<span class="fu">fmap</span> join fmma)</a>
<a class="sourceLine" id="cb13-19" title="19">        <span class="fu">=</span> t (<span class="fu">fmap</span> join fmma) <span class="fu">&gt;&gt;=</span> foldFree t</a>
<a class="sourceLine" id="cb13-20" title="20">        <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> (foldFree t) <span class="fu">.</span> t (<span class="fu">fmap</span> join fmma)</a>
<a class="sourceLine" id="cb13-21" title="21">        <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> (foldFree t) <span class="fu">.</span> <span class="fu">fmap</span> join <span class="fu">$</span> t fmma</a>
<a class="sourceLine" id="cb13-22" title="22">        <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> (foldFree t <span class="fu">.</span> join) <span class="fu">$</span> t fmma</a>
<a class="sourceLine" id="cb13-23" title="23">        <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> lhs <span class="fu">$</span> t fmma</a>
<a class="sourceLine" id="cb13-24" title="24"> <span class="fu">=</span> <span class="kw">case</span> mma <span class="kw">of</span></a>
<a class="sourceLine" id="cb13-25" title="25">     <span class="dt">Pure</span> ma   <span class="ot">-&gt;</span> t ma</a>
<a class="sourceLine" id="cb13-26" title="26">     <span class="dt">Free</span> fmma <span class="ot">-&gt;</span> join <span class="fu">.</span> <span class="fu">fmap</span> lhs <span class="fu">$</span> t fmma</a>
<a class="sourceLine" id="cb13-27" title="27"></a>
<a class="sourceLine" id="cb13-28" title="28">rhs mma</a>
<a class="sourceLine" id="cb13-29" title="29"> <span class="fu">=</span> <span class="kw">case</span> mma <span class="kw">of</span></a>
<a class="sourceLine" id="cb13-30" title="30">     <span class="dt">Pure</span> ma <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb13-31" title="31">       join <span class="fu">.</span> <span class="fu">fmap</span> (foldFree t) <span class="fu">.</span> foldFree t <span class="fu">$</span> <span class="dt">Pure</span> ma</a>
<a class="sourceLine" id="cb13-32" title="32">        <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> (foldFree t) <span class="fu">$</span> <span class="fu">return</span> ma</a>
<a class="sourceLine" id="cb13-33" title="33">        <span class="fu">=</span> join <span class="fu">$</span> <span class="fu">return</span> (t ma)</a>
<a class="sourceLine" id="cb13-34" title="34">        <span class="fu">=</span> t ma</a>
<a class="sourceLine" id="cb13-35" title="35">     <span class="dt">Free</span> fmma <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb13-36" title="36">       join <span class="fu">.</span> <span class="fu">fmap</span> (foldFree t) <span class="fu">.</span> foldFree t <span class="fu">$</span> <span class="dt">Free</span> fmma</a>
<a class="sourceLine" id="cb13-37" title="37">        <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> (foldFree t) <span class="fu">$</span> t fmma <span class="fu">&gt;&gt;=</span> foldFree t</a>
<a class="sourceLine" id="cb13-38" title="38">        <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> (foldFree t) <span class="fu">.</span> join <span class="fu">.</span> <span class="fu">fmap</span> (foldFree t) <span class="fu">$</span> t fmma</a>
<a class="sourceLine" id="cb13-39" title="39">        <span class="fu">=</span> join <span class="fu">.</span> join <span class="fu">.</span> <span class="fu">fmap</span> (<span class="fu">fmap</span> (foldFree t)) <span class="fu">.</span> <span class="fu">fmap</span> (foldFree t) <span class="fu">$</span> t fmma</a>
<a class="sourceLine" id="cb13-40" title="40">        <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> join <span class="fu">.</span> <span class="fu">fmap</span> (<span class="fu">fmap</span> (foldFree t)) <span class="fu">.</span> <span class="fu">fmap</span> foldFree t <span class="fu">$</span> t fmma</a>
<a class="sourceLine" id="cb13-41" title="41">        <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> (join <span class="fu">.</span> <span class="fu">fmap</span> (foldFree t) <span class="fu">.</span> foldFree t) <span class="fu">$</span> t fmma</a>
<a class="sourceLine" id="cb13-42" title="42">        <span class="fu">=</span> join <span class="fu">.</span> <span class="fu">fmap</span> rhs <span class="fu">$</span> t fmma</a>
<a class="sourceLine" id="cb13-43" title="43"> <span class="fu">=</span> <span class="kw">case</span> mma <span class="kw">of</span></a>
<a class="sourceLine" id="cb13-44" title="44">     <span class="dt">Pure</span> ma   <span class="ot">-&gt;</span> t ma</a>
<a class="sourceLine" id="cb13-45" title="45">     <span class="dt">Free</span> fmma <span class="ot">-&gt;</span> join <span class="fu">.</span> <span class="fu">fmap</span> rhs <span class="fu">$</span> t fmma</a>
<a class="sourceLine" id="cb13-46" title="46"></a>
<a class="sourceLine" id="cb13-47" title="47"><span class="co">-- よって、再帰的に、lhs = rhsでなければならない</span></a></code></pre></div>
<p><strong>条件1.と2.を満たすような<code>Monad</code>準同型はただ一つだけ存在する</strong></p>
<p>言い換えれば、任意の<code>Monad</code>準同型<code>ft :: Free f ~&gt; n</code>が <code>ft . liftF = t</code>を満たすなら、必ず<code>ft = foldFree t = foldFree (ft . liftF)</code>となります。</p>
<p>これは2段階に分けて証明しましょう。まず、<code>u :: n ~&gt; n'</code>を<code>Monad</code>準同型としたとき、 任意の<code>t :: f ~&gt; n</code>について<code>foldFree (u . t) = u . foldFree t</code>です。これは「<code>foldFree</code>の自然性」 と呼ぶことにします。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" title="1">lhs <span class="fu">=</span> foldFree (u <span class="fu">.</span> t)</a>
<a class="sourceLine" id="cb14-2" title="2">rhs <span class="fu">=</span> u <span class="fu">.</span> foldFree t</a>
<a class="sourceLine" id="cb14-3" title="3"></a>
<a class="sourceLine" id="cb14-4" title="4">lhs (<span class="dt">Pure</span> a)</a>
<a class="sourceLine" id="cb14-5" title="5"> <span class="fu">=</span> <span class="fu">return</span> a</a>
<a class="sourceLine" id="cb14-6" title="6">rhs (<span class="dt">Pure</span> a)</a>
<a class="sourceLine" id="cb14-7" title="7"> <span class="fu">=</span> u (<span class="fu">return</span><span class="ot"> a ::</span> n a)<span class="ot"> ::</span> n' a</a>
<a class="sourceLine" id="cb14-8" title="8"> <span class="fu">=</span> <span class="fu">return</span> a</a>
<a class="sourceLine" id="cb14-9" title="9"></a>
<a class="sourceLine" id="cb14-10" title="10">lhs (<span class="dt">Free</span> fma)</a>
<a class="sourceLine" id="cb14-11" title="11"> <span class="fu">=</span> foldFree (u <span class="fu">.</span> t) <span class="fu">$</span> <span class="dt">Free</span> fma</a>
<a class="sourceLine" id="cb14-12" title="12"> <span class="fu">=</span> (u <span class="fu">.</span> t) fma <span class="fu">&gt;&gt;=</span> foldFree (u <span class="fu">.</span> t)</a>
<a class="sourceLine" id="cb14-13" title="13"> <span class="fu">=</span> u (t fma) <span class="fu">&gt;&gt;=</span> lhs</a>
<a class="sourceLine" id="cb14-14" title="14">rhs (<span class="dt">Free</span> fma)</a>
<a class="sourceLine" id="cb14-15" title="15"> <span class="fu">=</span> u <span class="fu">.</span> foldFree t <span class="fu">$</span> <span class="dt">Free</span> fma</a>
<a class="sourceLine" id="cb14-16" title="16"> <span class="fu">=</span> u <span class="fu">$</span> t fma <span class="fu">&gt;&gt;=</span> foldFree t</a>
<a class="sourceLine" id="cb14-17" title="17"> <span class="fu">=</span> u (t fma) <span class="fu">&gt;&gt;=</span> u <span class="fu">.</span> foldFree t</a>
<a class="sourceLine" id="cb14-18" title="18"> <span class="fu">=</span> u (t fma) <span class="fu">&gt;&gt;=</span> rhs</a></code></pre></div>
<p>また、<code>foldFree liftF = id</code>です。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" title="1">foldFree liftF <span class="fu">$</span> <span class="dt">Pure</span> a</a>
<a class="sourceLine" id="cb15-2" title="2"> <span class="fu">=</span> <span class="fu">return</span> a</a>
<a class="sourceLine" id="cb15-3" title="3"> <span class="fu">=</span> <span class="dt">Pure</span> a</a>
<a class="sourceLine" id="cb15-4" title="4"></a>
<a class="sourceLine" id="cb15-5" title="5">foldFree liftF <span class="fu">$</span> <span class="dt">Free</span> fma</a>
<a class="sourceLine" id="cb15-6" title="6"> <span class="fu">=</span> liftF fma <span class="fu">&gt;&gt;=</span> foldFree liftF</a>
<a class="sourceLine" id="cb15-7" title="7"> <span class="fu">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> <span class="dt">Pure</span>) fma <span class="fu">&gt;&gt;=</span> foldFree liftF</a>
<a class="sourceLine" id="cb15-8" title="8"> <span class="fu">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> (<span class="fu">&gt;&gt;=</span> foldFree liftF) <span class="fu">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span> <span class="fu">$</span> fma)</a>
<a class="sourceLine" id="cb15-9" title="9"> <span class="fu">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> ((<span class="fu">&gt;&gt;=</span> foldFree liftF) <span class="fu">.</span> <span class="dt">Pure</span>) <span class="fu">$</span> fma)</a>
<a class="sourceLine" id="cb15-10" title="10"> <span class="fu">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> (<span class="fu">&gt;&gt;=</span> <span class="fu">return</span>) fma)</a>
<a class="sourceLine" id="cb15-11" title="11"> <span class="fu">=</span> <span class="dt">Free</span> fma</a></code></pre></div>
<p>したがって</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" title="1">foldFree (ft <span class="fu">.</span> liftF)</a>
<a class="sourceLine" id="cb16-2" title="2">   <span class="co">-- ft はMonad準同型 Free f ~&gt; n より、foldFreeの自然性から</span></a>
<a class="sourceLine" id="cb16-3" title="3"> <span class="fu">=</span> ft <span class="fu">.</span> foldFree liftF</a>
<a class="sourceLine" id="cb16-4" title="4">   <span class="co">-- foldFree liftF = id</span></a>
<a class="sourceLine" id="cb16-5" title="5"> <span class="fu">=</span> ft</a></code></pre></div>
<p>これらの事実を組み合わせれば、<code>FFunctor, FMonad</code>則を導くことができます。</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" title="1"><span class="co">-- 以下は定義から容易に確認できる</span></a>
<a class="sourceLine" id="cb17-2" title="2">fpure   <span class="fu">=</span> liftF</a>
<a class="sourceLine" id="cb17-3" title="3">fjoin   <span class="fu">=</span> retract <span class="fu">=</span> foldFree <span class="fu">id</span></a>
<a class="sourceLine" id="cb17-4" title="4"></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="co">-- 次の式は直接証明することもできるが、</span></a>
<a class="sourceLine" id="cb17-6" title="6">ffmap f <span class="fu">=</span> foldFree (liftF <span class="fu">.</span> f)</a>
<a class="sourceLine" id="cb17-7" title="7"><span class="co">-- より簡単に示せる以下の式</span></a>
<a class="sourceLine" id="cb17-8" title="8">ffmap f <span class="fu">.</span> liftF</a>
<a class="sourceLine" id="cb17-9" title="9"> <span class="fu">=</span> ffmap f <span class="fu">.</span> <span class="dt">Free</span> <span class="fu">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span></a>
<a class="sourceLine" id="cb17-10" title="10"> <span class="fu">=</span> <span class="dt">Free</span> <span class="fu">.</span> f <span class="fu">.</span> <span class="fu">fmap</span> (ffmap f) <span class="fu">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span></a>
<a class="sourceLine" id="cb17-11" title="11"> <span class="fu">=</span> <span class="dt">Free</span> <span class="fu">.</span> <span class="fu">fmap</span> (ffmap f <span class="fu">.</span> <span class="dt">Pure</span>) <span class="fu">.</span> f</a>
<a class="sourceLine" id="cb17-12" title="12"> <span class="fu">=</span> <span class="dt">Free</span> <span class="fu">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span> <span class="fu">.</span> f</a>
<a class="sourceLine" id="cb17-13" title="13"> <span class="fu">=</span> liftF <span class="fu">.</span> f</a>
<a class="sourceLine" id="cb17-14" title="14"><span class="co">-- およびffmapがMonad準同型であることから、`foldFree`の唯一性より</span></a>
<a class="sourceLine" id="cb17-15" title="15">ffmap f <span class="fu">=</span> foldFree (ffmap f <span class="fu">.</span> liftF)</a>
<a class="sourceLine" id="cb17-16" title="16">        <span class="fu">=</span> foldFree (liftF <span class="fu">.</span> f)</a>
<a class="sourceLine" id="cb17-17" title="17"></a>
<a class="sourceLine" id="cb17-18" title="18">[<span class="dt">FFunctor</span>則]</a>
<a class="sourceLine" id="cb17-19" title="19">  ffmap <span class="fu">id</span> <span class="fu">=</span> foldFree (liftF <span class="fu">.</span> <span class="fu">id</span>) <span class="fu">=</span> <span class="fu">id</span></a>
<a class="sourceLine" id="cb17-20" title="20">  ffmap f <span class="fu">.</span> ffmap g</a>
<a class="sourceLine" id="cb17-21" title="21">   <span class="fu">=</span> foldFree (liftF <span class="fu">.</span> f) <span class="fu">.</span> foldFree (liftF <span class="fu">.</span> g)</a>
<a class="sourceLine" id="cb17-22" title="22">     <span class="co">-- foldFreeの自然性(foldFree _ 自身もMonad準同型であることに注意)</span></a>
<a class="sourceLine" id="cb17-23" title="23">   <span class="fu">=</span> foldFree (foldFree (liftF <span class="fu">.</span> f) <span class="fu">.</span> liftF <span class="fu">.</span> g)</a>
<a class="sourceLine" id="cb17-24" title="24">     <span class="co">-- foldFree t . liftF = t</span></a>
<a class="sourceLine" id="cb17-25" title="25">   <span class="fu">=</span> foldFree (liftF <span class="fu">.</span> f <span class="fu">.</span> g)</a>
<a class="sourceLine" id="cb17-26" title="26">   <span class="fu">=</span> foldFree (liftF <span class="fu">.</span> (f <span class="fu">.</span> g))</a>
<a class="sourceLine" id="cb17-27" title="27">   <span class="fu">=</span> ffmap (f <span class="fu">.</span> g)</a>
<a class="sourceLine" id="cb17-28" title="28"></a>
<a class="sourceLine" id="cb17-29" title="29">[<span class="dt">FMonad</span>則 自然性]</a>
<a class="sourceLine" id="cb17-30" title="30">  <span class="co">-- fpure = liftFなので、これはすでに示している</span></a>
<a class="sourceLine" id="cb17-31" title="31">  ffmap f <span class="fu">.</span> fpure <span class="fu">=</span> fpure <span class="fu">.</span> f</a>
<a class="sourceLine" id="cb17-32" title="32">  </a>
<a class="sourceLine" id="cb17-33" title="33">  ffmap f <span class="fu">.</span> fjoin</a>
<a class="sourceLine" id="cb17-34" title="34">   <span class="fu">=</span> ffmap f <span class="fu">.</span> foldFree <span class="fu">id</span></a>
<a class="sourceLine" id="cb17-35" title="35">   <span class="fu">=</span> foldFree (ffmap f <span class="fu">.</span> <span class="fu">id</span>)</a>
<a class="sourceLine" id="cb17-36" title="36">   <span class="fu">=</span> foldFree (ffmap f)</a>
<a class="sourceLine" id="cb17-37" title="37">  fjoin <span class="fu">.</span> ffmap (ffmap f)</a>
<a class="sourceLine" id="cb17-38" title="38">   <span class="fu">=</span> foldFree <span class="fu">id</span> <span class="fu">.</span> foldFree (liftF <span class="fu">.</span> ffmap f)</a>
<a class="sourceLine" id="cb17-39" title="39">   <span class="fu">=</span> foldFree (foldFree <span class="fu">id</span> <span class="fu">.</span> liftF <span class="fu">.</span> ffmap f)</a>
<a class="sourceLine" id="cb17-40" title="40">   <span class="fu">=</span> foldFree (ffmap f)</a>
<a class="sourceLine" id="cb17-41" title="41"></a>
<a class="sourceLine" id="cb17-42" title="42">[<span class="dt">FMonad</span>則<span class="dt">Left</span> <span class="dt">Unit</span>]</a>
<a class="sourceLine" id="cb17-43" title="43">  fjoin <span class="fu">.</span> fpure</a>
<a class="sourceLine" id="cb17-44" title="44">   <span class="fu">=</span> foldFree <span class="fu">id</span> <span class="fu">.</span> liftF</a>
<a class="sourceLine" id="cb17-45" title="45">     <span class="co">-- foldFree t . liftF = t</span></a>
<a class="sourceLine" id="cb17-46" title="46">   <span class="fu">=</span> <span class="fu">id</span></a>
<a class="sourceLine" id="cb17-47" title="47"></a>
<a class="sourceLine" id="cb17-48" title="48">[<span class="dt">FMonad</span>則<span class="dt">Right</span> <span class="dt">Unit</span>]</a>
<a class="sourceLine" id="cb17-49" title="49">  fjoin <span class="fu">.</span> ffmap fpure</a>
<a class="sourceLine" id="cb17-50" title="50">   <span class="fu">=</span> foldFree <span class="fu">id</span> <span class="fu">.</span> foldFree (liftF <span class="fu">.</span> liftF)</a>
<a class="sourceLine" id="cb17-51" title="51">     <span class="co">-- foldFreeの自然性</span></a>
<a class="sourceLine" id="cb17-52" title="52">   <span class="fu">=</span> foldFree (foldFree <span class="fu">id</span> <span class="fu">.</span> liftF <span class="fu">.</span> liftF)</a>
<a class="sourceLine" id="cb17-53" title="53">     <span class="co">--        ^^^^^^^^^^^^^^^^^^^</span></a>
<a class="sourceLine" id="cb17-54" title="54">   <span class="fu">=</span> foldFree (<span class="fu">id</span> <span class="fu">.</span> liftF)</a>
<a class="sourceLine" id="cb17-55" title="55">   <span class="fu">=</span> foldFree liftF</a>
<a class="sourceLine" id="cb17-56" title="56">   <span class="fu">=</span> <span class="fu">id</span></a>
<a class="sourceLine" id="cb17-57" title="57"></a>
<a class="sourceLine" id="cb17-58" title="58">[<span class="dt">FMonad</span>則<span class="dt">Associativity</span>]</a>
<a class="sourceLine" id="cb17-59" title="59">  fjoin <span class="fu">.</span> fjoin</a>
<a class="sourceLine" id="cb17-60" title="60">   <span class="fu">=</span> foldFree <span class="fu">id</span> <span class="fu">.</span> foldFree <span class="fu">id</span></a>
<a class="sourceLine" id="cb17-61" title="61">   <span class="fu">=</span> foldFree (foldFree <span class="fu">id</span> <span class="fu">.</span> <span class="fu">id</span>)</a>
<a class="sourceLine" id="cb17-62" title="62">   <span class="fu">=</span> foldFree (foldFree <span class="fu">id</span>)</a>
<a class="sourceLine" id="cb17-63" title="63">  fjoin <span class="fu">.</span> ffmap fjoin</a>
<a class="sourceLine" id="cb17-64" title="64">   <span class="fu">=</span> foldFree <span class="fu">id</span> <span class="fu">.</span> foldFree (liftF <span class="fu">.</span> foldFree <span class="fu">id</span>)</a>
<a class="sourceLine" id="cb17-65" title="65">   <span class="fu">=</span> foldFree (foldFree <span class="fu">id</span> <span class="fu">.</span> liftF <span class="fu">.</span> foldFree <span class="fu">id</span>)</a>
<a class="sourceLine" id="cb17-66" title="66">     <span class="co">--        ^^^^^^^^^^^^^^^^^^^</span></a>
<a class="sourceLine" id="cb17-67" title="67">   <span class="fu">=</span> foldFree (<span class="fu">id</span> <span class="fu">.</span> foldFree <span class="fu">id</span>)</a>
<a class="sourceLine" id="cb17-68" title="68">   <span class="fu">=</span> foldFree (foldFree <span class="fu">id</span>)</a></code></pre></div>
<h2 id="なんでこの記事を書いたのか">なんでこの記事を書いたのか？</h2>
<p>この<code>FFunctor</code>や<code>FMonad</code>は、 じつは私が<a href="https://github.com/viercc/kitchen-sink-hs/blob/master/experiment/src/FMonad.hs">ついこの間書いた</a>ものです。<a href="https://www.reddit.com/r/haskell/comments/i76yx2/listt_instances_and_xderivingvia/">Redditでのこの話題</a>に対する反応なので、別に実用上の必要があったわけではありません。一応Hackageも漁りましたけど、category-extrasに存在したことがあるぐらいで、 今もメンテナンスされているパッケージには見つかりませんでした。多分他の人も必要なかったのか、自分の検索が足りてないかです。</p>
<p>ただ、割とよく似ているものに<a href="https://hackage.haskell.org/package/index-core">index-core</a>と<a href="https://hackage.haskell.org/package/mmorph">mmorph</a>とがあります。それぞれ、</p>
<ul>
<li>index-core: カインド<code>k -&gt; Type</code>をもつ任意の型コンストラクタ<code>f :: k -&gt; Type</code>上の関手やモナド
<ul>
<li>パッケージの元ネタ論文: <a href="https://personal.cis.strath.ac.uk/conor.mcbride/Kleisli.pdf">Kleisli arrows of outrageous fortune(pdf)</a></li>
<li>モナドは<code>IMonad</code>という名前</li>
</ul></li>
<li>mmorph: <code>Monad</code>上の関手やモナド
<ul>
<li><code>Monad</code>準同型だけを考える</li>
<li>モナドは<code>MMonad</code>という名前</li>
</ul></li>
</ul>
<p>です。<code>FMonad</code>は<code>Functor</code>上のモナドなので、上のどちらとも一般/特殊の関係にありません。しかも、例に挙げたように、 <code>FFunctor</code>、<code>FMonad</code>のインスタンスは多様で、かつたびたび使う型が含まれています。 ちょっと深堀りしてみる価値があるかな、と思ってやってみました。</p>
<p>次の表は<code>IMonad</code>、<code>MMonad</code>、<code>FMonad</code>の比較です。</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>Instance</th>
<th style="text-align: center;"><code>IMonad</code></th>
<th style="text-align: center;"><code>MMonad</code></th>
<th style="text-align: center;"><code>FMonad</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td></td>
<td><code>ReaderT e</code></td>
<td style="text-align: center;">✔</td>
<td style="text-align: center;">✔</td>
<td style="text-align: center;">✔</td>
</tr>
<tr class="even">
<td><code>Monoid w =&gt;</code></td>
<td><code>WriterT w</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✔</td>
<td style="text-align: center;">✔</td>
</tr>
<tr class="odd">
<td><code>Monad f =&gt;</code></td>
<td><code>Compose f</code></td>
<td style="text-align: center;">✔</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✔</td>
</tr>
<tr class="even">
<td></td>
<td><code>Sum f</code></td>
<td style="text-align: center;">✔</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✔</td>
</tr>
<tr class="odd">
<td></td>
<td><code>Free</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✔</td>
</tr>
<tr class="even">
<td><code>Functor f =&gt;</code></td>
<td><code>FreeT f</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✔ <sup>[1]</sup></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td></td>
<td><code>IxState</code> <sup>[2]</sup></td>
<td style="text-align: center;">✔</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<p><sup>[1]</sup> mmorphパッケージには無いけれど多分なれます。 また、<code>MMonad (FreeT f)</code>と<code>f</code>を固定して<code>m</code>を引数と見るのでなく、<code>m</code>を固定して<code>f</code>を引数と見るなら、<a href="https://github.com/viercc/kitchen-sink-hs/blob/master/experiment/src/FreeT_FMonad.md"><code>FreeT _ m</code>は<code>FMonad</code>です</a>。</p>
<p><sup>[2]</sup> IxState: 下記のもの。<code>s</code>が反変な位置にあるので<code>FMonad</code>になれません。 あと、<code>x</code>として、GADTを使ったものを入れないと、 計算後の状態の型がわからなくなるので、<code>Functor</code>な<code>x</code>だけを使うとかなり不便です。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">data</span> <span class="dt">IxState</span> x s <span class="kw">where</span></a>
<a class="sourceLine" id="cb18-2" title="2">  <span class="dt">IxState</span><span class="ot"> ::</span> (s <span class="ot">-&gt;</span> (t, x t)) <span class="ot">-&gt;</span> <span class="dt">IxState</span> x s</a></code></pre></div>
    </section>
</article>

        </main>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
    </body>
</html>
