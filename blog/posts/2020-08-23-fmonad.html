<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Too lazy to evaluate - Functor上のモナド、FMonadについて</title>
        <link rel="stylesheet" href="../css/syntax.css" />
        <link rel="stylesheet" href="../css/default.css" />
        <!-- KaTeX -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.9/dist/katex.min.css" integrity="sha384-r/BYDnh2ViiCwqZt5VJVWuADDic3NnnTIEOv4hOh05nSfB6tjWpKmn1kUHOVkMXc" crossorigin="anonymous">
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.9/dist/katex.min.js" integrity="sha384-zDIgORxjImEWftZXZpWLs2l57fMX9B3yWFPN5Ecabe211Hm5ZG/OIz2b07DYPUcH" crossorigin="anonymous"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.9/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"></script>
        <script defer src="../js/katex-render-hook.js"></script>
    </head>
    <body>
        <header>
            <div class="logo">
                <a href="../">Too lazy to evaluate</a>
            </div>
            <nav>
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </nav>
        </header>

        <main role="main">
            <h1>Functor上のモナド、FMonadについて</h1>
            <article>
    <section class="header">
        Posted on August 23, 2020
        
    </section>
    <section>
        <h1 id="モナドはmonad以外にもある">モナドは<code>Monad</code>以外にもある</h1>
<p>この記事では、「モナド」と「<code>Monad</code>」とを違う意味の言葉として使いわけます。 <a href="https://ja.wikipedia.org/wiki/%E3%83%A2%E3%83%8A%E3%83%89_(%E5%9C%8F%E8%AB%96)">モナド (圏論)</a>のうち、 ある特殊な場合が<code>Monad</code>である、とします。</p>
<p>詳しい説明はここではしませんが、 次の<code>FMonad</code>は、「モナドだけど<code>Monad</code>じゃない」 性質を表す型クラスです。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Natural</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> (<span class="op">~&gt;</span>) f g <span class="ot">=</span> <span class="kw">forall</span> x<span class="op">.</span> f x <span class="ot">-&gt;</span> g x</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Functor on Functors</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> (<span class="kw">forall</span> g<span class="op">.</span> <span class="dt">Functor</span> g <span class="ot">=&gt;</span> <span class="dt">Functor</span> (ff g)) <span class="ot">=&gt;</span> <span class="dt">FFunctor</span> ff <span class="kw">where</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ot">    ffmap ::</span> (<span class="dt">Functor</span> g, <span class="dt">Functor</span> h) <span class="ot">=&gt;</span> (g <span class="op">~&gt;</span> h) <span class="ot">-&gt;</span> (ff g <span class="op">~&gt;</span> ff h)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Monad on Functors</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">FFunctor</span> ff <span class="ot">=&gt;</span> <span class="dt">FMonad</span> ff <span class="kw">where</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="ot">    fpure ::</span> (<span class="dt">Functor</span> g) <span class="ot">=&gt;</span> g <span class="op">~&gt;</span> ff g</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="ot">    fjoin ::</span> (<span class="dt">Functor</span> g) <span class="ot">=&gt;</span> ff (ff g) <span class="op">~&gt;</span> ff g</span></code></pre></div>
<p><code>FFunctor</code>と<code>FMonad</code>は、 <code>Functor</code>と<code>Monad</code>によく似ていることがわかります。 さらに、<code>FFunctor</code>則と<code>FMonad</code>則も<code>Functor</code>、<code>Monad</code>のものにそっくりです。 これらをまとめて抽象化できるのが、一般的なほうの「モナド」です。</p>
<pre><code>FFunctor laws:
    ffmap id = id
    ffmap f . ffmap g = ffmap (f . g)

FMonad laws:
[fpure is natural in g]
    ∀(n :: g ~&gt; h). ffmap n . fpure = fpure . n

[fjoin is natural in g]
    ∀(n :: g ~&gt; h). ffmap n . fjoin = fjoin . ffmap (ffmap n)

[Left unit]
    fjoin . fpure = id

[Right unit]
    fjoin . fmap fpure = id

[Associativity]
    fjoin . fjoin = fjoin . ffmap fjoin</code></pre>
<h2 id="具体例1readert-e">具体例1:<code>ReaderT e</code></h2>
<p><code>ReaderT e</code>は<code>FFunctor</code>かつ<code>FMonad</code>になります。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">ReadeT</span> e m a <span class="ot">=</span> <span class="dt">ReaderT</span> {<span class="ot"> runReaderT ::</span> e <span class="ot">-&gt;</span> m a }</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Functor</span> m     <span class="ot">=&gt;</span> <span class="dt">Functor</span> (<span class="dt">ReaderT</span> e m)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Applicative</span> m <span class="ot">=&gt;</span> <span class="dt">Applicative</span> (<span class="dt">ReaderT</span> e m)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Monad</span> m       <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">ReaderT</span> e m)</span></code></pre></div>
<p>これが、次のように<code>FFunctor, FMonad</code>になります。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FFunctor</span> (<span class="dt">ReaderT</span> e) <span class="kw">where</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ffmap ::</span> (<span class="dt">Functor</span> f, <span class="dt">Functor</span> g) <span class="ot">=&gt;</span> (f <span class="op">~&gt;</span> g) <span class="ot">-&gt;</span> (<span class="dt">ReaderT</span> e f <span class="op">~&gt;</span> <span class="dt">ReaderT</span> e g)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">{-  ffmap :: (Functor f, Functor g)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">          =&gt; (forall x. f x -&gt; g x) -&gt; (forall y. ReaderT e f y -&gt; ReaderT e g y)  -}</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    ffmap fg my <span class="ot">=</span> <span class="dt">ReaderT</span> <span class="op">.</span> <span class="fu">fmap</span> fg <span class="op">.</span> runReaderT</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FMonad</span> (<span class="dt">ReaderT</span> e) <span class="kw">where</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="ot">    fpure ::</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> f <span class="op">~&gt;</span> <span class="dt">ReaderT</span> e f</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">{-  fpure :: f x -&gt; ReaderT e f x  -}</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    fpure <span class="ot">=</span> <span class="dt">ReaderT</span> <span class="op">.</span> (<span class="fu">return</span><span class="ot"> ::</span> f x <span class="ot">-&gt;</span> (e <span class="ot">-&gt;</span> f x))</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="ot">    fjoin ::</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">ReaderT</span> e (<span class="dt">ReaderT</span> e f) <span class="op">~&gt;</span> <span class="dt">ReaderT</span> e f</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    fjoin <span class="ot">=</span> <span class="dt">ReaderT</span> <span class="op">.</span> (<span class="ot">join ::</span> (e <span class="ot">-&gt;</span> e <span class="ot">-&gt;</span> f x) <span class="ot">-&gt;</span> e <span class="ot">-&gt;</span> f x) <span class="op">.</span> <span class="fu">fmap</span> runReaderT <span class="op">.</span> runReaderT</span></code></pre></div>
<p><code>ReaderT e f x</code> は、<code>newtype</code>を外せば <code>e -&gt; f x</code> で、これは <code>Monad</code>である<code>(e -&gt; _)</code> と、<code>Monad</code>とは限らない <code>f</code> の合成Functorと見ることができます。 <code>m ~ ((-&gt;) e)</code>とおけば、<code>fpure</code>は<code>return</code>で<code>f x</code>を包んで<code>m (f x)</code>にして、 <code>fjoin</code>は<code>join</code>で<code>m (m (f x))</code>を潰して<code>m (f x)</code>にしているだけです。</p>
<p>一般化すれば、Functorの合成（<a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Data-Functor-Compose.html">Data.Functor.Compose</a>）に対して、次のインスタンスが作れます。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Functor</span> m <span class="ot">=&gt;</span> <span class="dt">FFunctor</span> (<span class="dt">Compose</span> m)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Monad</span> m   <span class="ot">=&gt;</span> <span class="dt">FMonad</span> (<span class="dt">Compose</span> m)</span></code></pre></div>
<h2 id="具体例2writert-w">具体例2:<code>WriterT w</code></h2>
<p><code>WriterT w</code>も<code>FFunctor</code>かつ<code>FMonad</code>になります。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">WriterT</span> w m a <span class="ot">=</span> <span class="dt">WriterT</span> {<span class="ot"> runWriterT ::</span> m (a, w) }</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Functor</span> m     <span class="ot">=&gt;</span> <span class="dt">Functor</span> (<span class="dt">WriterT</span> e m)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Applicative</span> m <span class="ot">=&gt;</span> <span class="dt">Applicative</span> (<span class="dt">WriterT</span> e m)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Monad</span> m       <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">WriterT</span> e m)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FFunctor</span> (<span class="dt">WriterT</span> w) <span class="kw">where</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    ffmap fg <span class="ot">=</span> <span class="dt">WriterT</span> <span class="op">.</span> fg <span class="op">.</span> runWriterT</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Monoid</span> w) <span class="ot">=&gt;</span> <span class="dt">FMonad</span> (<span class="dt">WriterT</span> w) <span class="kw">where</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="ot">    fpure ::</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> f <span class="op">~&gt;</span> <span class="dt">WriterT</span> w f</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    fpure <span class="ot">=</span> <span class="dt">WriterT</span> <span class="op">.</span> <span class="fu">fmap</span> returnWriter</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">where</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        returnWriter x <span class="ot">=</span> (x, <span class="fu">mempty</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- return x = Writer (x, mempty) :: Writer w x</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="ot">    fjoin ::</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">WriterT</span> w (<span class="dt">WriterT</span> w f) <span class="op">~&gt;</span> <span class="dt">WriterT</span> w f</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    fjoin <span class="ot">=</span> <span class="dt">WriterT</span> <span class="op">.</span> <span class="fu">fmap</span> joinWriter <span class="op">.</span> runWriterT <span class="op">.</span> runWriterT</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">where</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        joinWriter ((x,w2),w1) <span class="ot">=</span> (x, w1 <span class="op">&lt;&gt;</span> w2)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- join (Writer (Writer (x, w2), w1)) = Writer (x, w1 &lt;&gt; w2)</span></span></code></pre></div>
<p>1つめの例と同じように、これは任意の<code>Monad m</code>に拡張できて、 内側に<code>Monad m</code>を合成する<code>(`Compose` m)</code>は、 <code>FMonad</code>になります。</p>
<p>ただし、Haskellは<code>(`Compose` m)</code>のような型を作れないので、 それ用の新しい型を定義する必要があります。</p>
<pre><code>newtype FlipCompose m f a = FlipCompose { getFlipCompose :: f (m a) }

instance (Functor m, Functor f) =&gt; Functor (FlipCompose m f)
instance (Functor m) =&gt; FFunctor (FlipCompose m)
instance (Monad m)   =&gt; FMonad (FlipCompose m)</code></pre>
<h2 id="具体例3sum-f">具体例3:<code>Sum f</code></h2>
<p>これまでMonad Transformerばかりでしたが、<code>FMonad</code>がそうしたものに限られるわけではありません。 <code>Sum f</code>（<a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Data-Functor-Sum.html">Data.Functor.Sum</a>）は<code>FMonad</code>です。これは、Monad Transformerでないどころか、<code>Monad</code>とは何の関係もありません。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Sum</span> f g a <span class="ot">=</span> <span class="dt">InL</span> (f a) <span class="op">|</span> <span class="dt">InR</span> (g a)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Functor</span> f, <span class="dt">Functor</span> g) <span class="ot">=&gt;</span> <span class="dt">Functor</span> (<span class="dt">Sum</span> f g)</span></code></pre></div>
<p>その<code>FMonad</code>のインスタンスは、<code>Either</code>の<code>Monad</code>インスタンスとほぼ同じです。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">FFunctor</span> (<span class="dt">Sum</span> f) <span class="kw">where</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ffmap ::</span> (<span class="dt">Functor</span> g, <span class="dt">Functor</span> h) <span class="ot">=&gt;</span> (g <span class="op">~&gt;</span> h) <span class="ot">-&gt;</span> (<span class="dt">Sum</span> f g <span class="op">~&gt;</span> <span class="dt">Sum</span> f h)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    ffmap _  (<span class="dt">InL</span> fx) <span class="ot">=</span> <span class="dt">InL</span> fx</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    ffmap gh (<span class="dt">InR</span> gx) <span class="ot">=</span> <span class="dt">InR</span> (gh gx)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">FMonad</span> (<span class="dt">Sum</span> f) <span class="kw">where</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ot">    fpure ::</span> (<span class="dt">Functor</span> g) <span class="ot">=&gt;</span> g <span class="op">~&gt;</span> <span class="dt">Sum</span> f g</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    fpure <span class="ot">=</span> <span class="dt">InR</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="ot">    fjoin ::</span> (<span class="dt">Functor</span> g) <span class="ot">=&gt;</span> <span class="dt">Sum</span> f (<span class="dt">Sum</span> f g) <span class="op">~&gt;</span> <span class="dt">Sum</span> f g</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    fjoin (<span class="dt">InL</span> fx)       <span class="ot">=</span> <span class="dt">InL</span> fx</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    fjoin (<span class="dt">InR</span> (<span class="dt">InL</span> fx)) <span class="ot">=</span> <span class="dt">InL</span> fx</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    fjoin (<span class="dt">InR</span> (<span class="dt">InR</span> gx)) <span class="ot">=</span> <span class="dt">InR</span> gx</span></code></pre></div>
<h2 id="具体例4free-f">具体例4:<code>Free f</code></h2>
<p>Free Monad（<a href="https://hackage.haskell.org/package/free-5.1.3/docs/Control-Monad-Free.html#t:Free">Free</a>）は<code>FMonad</code>です。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Free</span> f a <span class="ot">=</span> <span class="dt">Pure</span> a <span class="op">|</span> <span class="dt">Free</span> (f (<span class="dt">Free</span> f a))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">Functor</span> (<span class="dt">Free</span> f)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">Applicative</span> (<span class="dt">Free</span> f)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">Free</span> f) <span class="kw">where</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="ot">=</span> <span class="dt">Pure</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Pure</span> a   <span class="op">&gt;&gt;=</span> k <span class="ot">=</span> k a</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Free</span> fma <span class="op">&gt;&gt;=</span> k <span class="ot">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> (<span class="op">&gt;&gt;=</span> k) fma)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FFunctor</span> <span class="dt">Free</span> <span class="kw">where</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    ffmap <span class="ot">=</span> hoistFree</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FMonad</span> <span class="dt">Free</span> <span class="kw">where</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    fpure <span class="ot">=</span> liftF</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    fjoin <span class="ot">=</span> foldFree <span class="fu">id</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- これらはControl.Monad.Freeにある関数ですが、</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co">-- 参照しやすさのためにここにコピペします</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- | The very definition of a free monad is that given a natural transformation you get a monad homomorphism.</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="ot">foldFree ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> (<span class="kw">forall</span> x <span class="op">.</span> f x <span class="ot">-&gt;</span> m x) <span class="ot">-&gt;</span> <span class="dt">Free</span> f a <span class="ot">-&gt;</span> m a</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>foldFree _ (<span class="dt">Pure</span> a)  <span class="ot">=</span> <span class="fu">return</span> a</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>foldFree f (<span class="dt">Free</span> as) <span class="ot">=</span> f as <span class="op">&gt;&gt;=</span> foldFree f</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="ot">hoistFree ::</span> (<span class="dt">Functor</span> g) <span class="ot">=&gt;</span> (f <span class="op">~&gt;</span> g) <span class="ot">-&gt;</span> (<span class="dt">Free</span> f <span class="op">~&gt;</span> <span class="dt">Free</span> g)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>hoistFree fg <span class="ot">=</span> go</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    go (<span class="dt">Pure</span> x)   <span class="ot">=</span> <span class="dt">Pure</span> x</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    go (<span class="dt">Free</span> fmx) <span class="ot">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> go (fg fmx))</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="ot">liftF ::</span> (<span class="dt">Functor</span> f) <span class="ot">=&gt;</span> f <span class="op">~&gt;</span> <span class="dt">Free</span> f</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>liftF fx <span class="ot">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> <span class="dt">Pure</span> fx)</span></code></pre></div>
<p>ここまでの例では省略してきましたが、<code>FFunctor</code>則・<code>FMonad</code>則も証明していきたいと思います。 その前に、次の有用な事実を確認しておきます: 任意の<code>Functor f, Monad n</code>および<code>t :: f ~&gt; n</code>に対して、</p>
<ol type="1">
<li><code>foldFree t . liftF = t</code></li>
<li><code>foldFree t</code>は<code>Monad</code>準同型</li>
<li>条件1.と2.を満たすような<code>Monad</code>準同型は<code>foldFree t</code>ただ一つだけ存在する</li>
</ol>
<p>ここで、<code>ft</code>が<code>Monad</code>準同型であるとは、次の条件を満たすことをいいます。</p>
<ul>
<li><code>ft . return = ft</code></li>
<li><code>ft . join = join . fmap ft . ft</code>
<ul>
<li><p>あるいは、これと同値な</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>  ft <span class="op">$</span> <span class="kw">do</span> x <span class="ot">&lt;-</span> mx</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>         k x</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ot">=</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">do</span> x <span class="ot">&lt;-</span> ft mx</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>     ft (k x)</span></code></pre></div></li>
</ul></li>
</ul>
<p><strong><code>foldFree t . liftF = t</code></strong></p>
<p>これは定義を展開していけばすぐです。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>foldFree t <span class="op">.</span> liftF</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> foldFree t <span class="op">.</span> <span class="dt">Free</span> <span class="op">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> (<span class="op">&gt;&gt;=</span> foldFree t) <span class="op">.</span> t <span class="op">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> (<span class="op">&gt;&gt;=</span> foldFree t) <span class="op">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span> <span class="op">.</span> t</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> (<span class="op">&gt;&gt;=</span> foldFree t <span class="op">.</span> <span class="dt">Pure</span>) <span class="op">.</span> t</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> (<span class="op">&gt;&gt;=</span> <span class="fu">return</span>) <span class="op">.</span> t</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> t</span></code></pre></div>
<p><strong><code>foldFree t</code>は<code>Monad</code>準同型</strong></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>foldFree t <span class="op">.</span> <span class="fu">return</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> foldFree t <span class="op">.</span> <span class="dt">Pure</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">return</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- 次式を示したい</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>foldFree t <span class="op">.</span> join <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> (foldFree t) <span class="op">.</span> foldFree t</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>lhs mma <span class="ot">=</span> foldFree t <span class="op">$</span> join mma</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>rhs mma <span class="ot">=</span> join <span class="op">.</span> foldFree t <span class="op">.</span> foldFree t <span class="op">$</span> mma</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>lhs mma</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="kw">case</span> mma <span class="kw">of</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Pure</span> ma   <span class="ot">-&gt;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>       foldFree t <span class="op">$</span> join (<span class="dt">Pure</span> ma)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> t ma</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Free</span> fmma <span class="ot">-&gt;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>       foldFree t <span class="op">$</span> join (<span class="dt">Free</span> fmma)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> foldFree t <span class="op">$</span> <span class="dt">Free</span> (<span class="fu">fmap</span> join fmma)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> t (<span class="fu">fmap</span> join fmma) <span class="op">&gt;&gt;=</span> foldFree t</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> (foldFree t) <span class="op">.</span> t (<span class="fu">fmap</span> join fmma)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> (foldFree t) <span class="op">.</span> <span class="fu">fmap</span> join <span class="op">$</span> t fmma</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> (foldFree t <span class="op">.</span> join) <span class="op">$</span> t fmma</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> lhs <span class="op">$</span> t fmma</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="kw">case</span> mma <span class="kw">of</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Pure</span> ma   <span class="ot">-&gt;</span> t ma</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Free</span> fmma <span class="ot">-&gt;</span> join <span class="op">.</span> <span class="fu">fmap</span> lhs <span class="op">$</span> t fmma</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>rhs mma</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="kw">case</span> mma <span class="kw">of</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Pure</span> ma <span class="ot">-&gt;</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>       join <span class="op">.</span> <span class="fu">fmap</span> (foldFree t) <span class="op">.</span> foldFree t <span class="op">$</span> <span class="dt">Pure</span> ma</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> (foldFree t) <span class="op">$</span> <span class="fu">return</span> ma</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> join <span class="op">$</span> <span class="fu">return</span> (t ma)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> t ma</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Free</span> fmma <span class="ot">-&gt;</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>       join <span class="op">.</span> <span class="fu">fmap</span> (foldFree t) <span class="op">.</span> foldFree t <span class="op">$</span> <span class="dt">Free</span> fmma</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> (foldFree t) <span class="op">$</span> t fmma <span class="op">&gt;&gt;=</span> foldFree t</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> (foldFree t) <span class="op">.</span> join <span class="op">.</span> <span class="fu">fmap</span> (foldFree t) <span class="op">$</span> t fmma</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> join <span class="op">.</span> join <span class="op">.</span> <span class="fu">fmap</span> (<span class="fu">fmap</span> (foldFree t)) <span class="op">.</span> <span class="fu">fmap</span> (foldFree t) <span class="op">$</span> t fmma</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> join <span class="op">.</span> <span class="fu">fmap</span> (<span class="fu">fmap</span> (foldFree t)) <span class="op">.</span> <span class="fu">fmap</span> foldFree t <span class="op">$</span> t fmma</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> (join <span class="op">.</span> <span class="fu">fmap</span> (foldFree t) <span class="op">.</span> foldFree t) <span class="op">$</span> t fmma</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> join <span class="op">.</span> <span class="fu">fmap</span> rhs <span class="op">$</span> t fmma</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="kw">case</span> mma <span class="kw">of</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Pure</span> ma   <span class="ot">-&gt;</span> t ma</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>     <span class="dt">Free</span> fmma <span class="ot">-&gt;</span> join <span class="op">.</span> <span class="fu">fmap</span> rhs <span class="op">$</span> t fmma</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="co">-- よって、再帰的に、lhs = rhsでなければならない</span></span></code></pre></div>
<p><strong>条件1.と2.を満たすような<code>Monad</code>準同型はただ一つだけ存在する</strong></p>
<p>言い換えれば、任意の<code>Monad</code>準同型<code>ft :: Free f ~&gt; n</code>が <code>ft . liftF = t</code>を満たすなら、必ず<code>ft = foldFree t = foldFree (ft . liftF)</code>となります。</p>
<p>これは2段階に分けて証明しましょう。まず、<code>u :: n ~&gt; n'</code>を<code>Monad</code>準同型としたとき、 任意の<code>t :: f ~&gt; n</code>について<code>foldFree (u . t) = u . foldFree t</code>です。これは「<code>foldFree</code>の自然性」 と呼ぶことにします。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>lhs <span class="ot">=</span> foldFree (u <span class="op">.</span> t)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>rhs <span class="ot">=</span> u <span class="op">.</span> foldFree t</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>lhs (<span class="dt">Pure</span> a)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">return</span> a</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>rhs (<span class="dt">Pure</span> a)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> u (<span class="fu">return</span><span class="ot"> a ::</span> n a)<span class="ot"> ::</span> n' a</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">return</span> a</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>lhs (<span class="dt">Free</span> fma)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> foldFree (u <span class="op">.</span> t) <span class="op">$</span> <span class="dt">Free</span> fma</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> (u <span class="op">.</span> t) fma <span class="op">&gt;&gt;=</span> foldFree (u <span class="op">.</span> t)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> u (t fma) <span class="op">&gt;&gt;=</span> lhs</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>rhs (<span class="dt">Free</span> fma)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> u <span class="op">.</span> foldFree t <span class="op">$</span> <span class="dt">Free</span> fma</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> u <span class="op">$</span> t fma <span class="op">&gt;&gt;=</span> foldFree t</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> u (t fma) <span class="op">&gt;&gt;=</span> u <span class="op">.</span> foldFree t</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> u (t fma) <span class="op">&gt;&gt;=</span> rhs</span></code></pre></div>
<p>また、<code>foldFree liftF = id</code>です。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>foldFree liftF <span class="op">$</span> <span class="dt">Pure</span> a</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="fu">return</span> a</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">Pure</span> a</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>foldFree liftF <span class="op">$</span> <span class="dt">Free</span> fma</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> liftF fma <span class="op">&gt;&gt;=</span> foldFree liftF</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> <span class="dt">Pure</span>) fma <span class="op">&gt;&gt;=</span> foldFree liftF</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> (<span class="op">&gt;&gt;=</span> foldFree liftF) <span class="op">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span> <span class="op">$</span> fma)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> ((<span class="op">&gt;&gt;=</span> foldFree liftF) <span class="op">.</span> <span class="dt">Pure</span>) <span class="op">$</span> fma)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">Free</span> (<span class="fu">fmap</span> (<span class="op">&gt;&gt;=</span> <span class="fu">return</span>) fma)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">Free</span> fma</span></code></pre></div>
<p>したがって</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>foldFree (ft <span class="op">.</span> liftF)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- ft はMonad準同型 Free f ~&gt; n より、foldFreeの自然性から</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> ft <span class="op">.</span> foldFree liftF</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- foldFree liftF = id</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> ft</span></code></pre></div>
<p>これらの事実を組み合わせれば、<code>FFunctor, FMonad</code>則を導くことができます。</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 以下は定義から容易に確認できる</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>fpure   <span class="ot">=</span> liftF</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>fjoin   <span class="ot">=</span> retract <span class="ot">=</span> foldFree <span class="fu">id</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- 次の式は直接証明することもできるが、</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>ffmap f <span class="ot">=</span> foldFree (liftF <span class="op">.</span> f)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- より簡単に示せる以下の式</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>ffmap f <span class="op">.</span> liftF</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> ffmap f <span class="op">.</span> <span class="dt">Free</span> <span class="op">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">Free</span> <span class="op">.</span> f <span class="op">.</span> <span class="fu">fmap</span> (ffmap f) <span class="op">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">Free</span> <span class="op">.</span> <span class="fu">fmap</span> (ffmap f <span class="op">.</span> <span class="dt">Pure</span>) <span class="op">.</span> f</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> <span class="dt">Free</span> <span class="op">.</span> <span class="fu">fmap</span> <span class="dt">Pure</span> <span class="op">.</span> f</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a> <span class="ot">=</span> liftF <span class="op">.</span> f</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- およびffmapがMonad準同型であることから、`foldFree`の唯一性より</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>ffmap f <span class="ot">=</span> foldFree (ffmap f <span class="op">.</span> liftF)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span> foldFree (liftF <span class="op">.</span> f)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>[<span class="dt">FFunctor</span>則]</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  ffmap <span class="fu">id</span> <span class="ot">=</span> foldFree (liftF <span class="op">.</span> <span class="fu">id</span>) <span class="ot">=</span> <span class="fu">id</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  ffmap f <span class="op">.</span> ffmap g</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (liftF <span class="op">.</span> f) <span class="op">.</span> foldFree (liftF <span class="op">.</span> g)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>     <span class="co">-- foldFreeの自然性(foldFree _ 自身もMonad準同型であることに注意)</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (foldFree (liftF <span class="op">.</span> f) <span class="op">.</span> liftF <span class="op">.</span> g)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>     <span class="co">-- foldFree t . liftF = t</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (liftF <span class="op">.</span> f <span class="op">.</span> g)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (liftF <span class="op">.</span> (f <span class="op">.</span> g))</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> ffmap (f <span class="op">.</span> g)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>[<span class="dt">FMonad</span>則 自然性]</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- fpure = liftFなので、これはすでに示している</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>  ffmap f <span class="op">.</span> fpure <span class="ot">=</span> fpure <span class="op">.</span> f</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  ffmap f <span class="op">.</span> fjoin</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> ffmap f <span class="op">.</span> foldFree <span class="fu">id</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (ffmap f <span class="op">.</span> <span class="fu">id</span>)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (ffmap f)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>  fjoin <span class="op">.</span> ffmap (ffmap f)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree <span class="fu">id</span> <span class="op">.</span> foldFree (liftF <span class="op">.</span> ffmap f)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (foldFree <span class="fu">id</span> <span class="op">.</span> liftF <span class="op">.</span> ffmap f)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (ffmap f)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>[<span class="dt">FMonad</span>則<span class="dt">Left</span> <span class="dt">Unit</span>]</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>  fjoin <span class="op">.</span> fpure</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree <span class="fu">id</span> <span class="op">.</span> liftF</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>     <span class="co">-- foldFree t . liftF = t</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> <span class="fu">id</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>[<span class="dt">FMonad</span>則<span class="dt">Right</span> <span class="dt">Unit</span>]</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>  fjoin <span class="op">.</span> ffmap fpure</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree <span class="fu">id</span> <span class="op">.</span> foldFree (liftF <span class="op">.</span> liftF)</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>     <span class="co">-- foldFreeの自然性</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (foldFree <span class="fu">id</span> <span class="op">.</span> liftF <span class="op">.</span> liftF)</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>     <span class="co">--        ^^^^^^^^^^^^^^^^^^^</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (<span class="fu">id</span> <span class="op">.</span> liftF)</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree liftF</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> <span class="fu">id</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>[<span class="dt">FMonad</span>則<span class="dt">Associativity</span>]</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>  fjoin <span class="op">.</span> fjoin</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree <span class="fu">id</span> <span class="op">.</span> foldFree <span class="fu">id</span></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (foldFree <span class="fu">id</span> <span class="op">.</span> <span class="fu">id</span>)</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (foldFree <span class="fu">id</span>)</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>  fjoin <span class="op">.</span> ffmap fjoin</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree <span class="fu">id</span> <span class="op">.</span> foldFree (liftF <span class="op">.</span> foldFree <span class="fu">id</span>)</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (foldFree <span class="fu">id</span> <span class="op">.</span> liftF <span class="op">.</span> foldFree <span class="fu">id</span>)</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>     <span class="co">--        ^^^^^^^^^^^^^^^^^^^</span></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (<span class="fu">id</span> <span class="op">.</span> foldFree <span class="fu">id</span>)</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>   <span class="ot">=</span> foldFree (foldFree <span class="fu">id</span>)</span></code></pre></div>
<h2 id="なんでこの記事を書いたのか">なんでこの記事を書いたのか？</h2>
<p>この<code>FFunctor</code>や<code>FMonad</code>は、 じつは私が<a href="https://github.com/viercc/kitchen-sink-hs/blob/master/experiment/src/FMonad.hs">ついこの間書いた</a>ものです。<a href="https://www.reddit.com/r/haskell/comments/i76yx2/listt_instances_and_xderivingvia/">Redditでのこの話題</a>に対する反応なので、別に実用上の必要があったわけではありません。一応Hackageも漁りましたけど、category-extrasに存在したことがあるぐらいで、 今もメンテナンスされているパッケージには見つかりませんでした。多分他の人も必要なかったのか、自分の検索が足りてないかです。</p>
<p>ただ、割とよく似ているものに<a href="https://hackage.haskell.org/package/index-core">index-core</a>と<a href="https://hackage.haskell.org/package/mmorph">mmorph</a>とがあります。それぞれ、</p>
<ul>
<li>index-core: カインド<code>k -&gt; Type</code>をもつ任意の型コンストラクタ<code>f :: k -&gt; Type</code>上の関手やモナド
<ul>
<li>パッケージの元ネタ論文: <a href="https://personal.cis.strath.ac.uk/conor.mcbride/Kleisli.pdf">Kleisli arrows of outrageous fortune(pdf)</a></li>
<li>モナドは<code>IMonad</code>という名前</li>
</ul></li>
<li>mmorph: <code>Monad</code>上の関手やモナド
<ul>
<li><code>Monad</code>準同型だけを考える</li>
<li>モナドは<code>MMonad</code>という名前</li>
</ul></li>
</ul>
<p>です。<code>FMonad</code>は<code>Functor</code>上のモナドなので、上のどちらとも一般/特殊の関係にありません。しかも、例に挙げたように、 <code>FFunctor</code>、<code>FMonad</code>のインスタンスは多様で、かつたびたび使う型が含まれています。 ちょっと深堀りしてみる価値があるかな、と思ってやってみました。</p>
<p>次の表は<code>IMonad</code>、<code>MMonad</code>、<code>FMonad</code>の比較です。</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>Instance</th>
<th style="text-align: center;"><code>IMonad</code></th>
<th style="text-align: center;"><code>MMonad</code></th>
<th style="text-align: center;"><code>FMonad</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td></td>
<td><code>ReaderT e</code></td>
<td style="text-align: center;">✔</td>
<td style="text-align: center;">✔</td>
<td style="text-align: center;">✔</td>
</tr>
<tr class="even">
<td><code>Monoid w =&gt;</code></td>
<td><code>WriterT w</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✔</td>
<td style="text-align: center;">✔</td>
</tr>
<tr class="odd">
<td><code>Monad f =&gt;</code></td>
<td><code>Compose f</code></td>
<td style="text-align: center;">✔</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✔</td>
</tr>
<tr class="even">
<td></td>
<td><code>Sum f</code></td>
<td style="text-align: center;">✔</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✔</td>
</tr>
<tr class="odd">
<td></td>
<td><code>Free</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✔</td>
</tr>
<tr class="even">
<td><code>Functor f =&gt;</code></td>
<td><code>FreeT f</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✔ <sup>[1]</sup></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td></td>
<td><code>IxState</code> <sup>[2]</sup></td>
<td style="text-align: center;">✔</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<p><sup>[1]</sup> mmorphパッケージには無いけれど多分なれます。 また、<code>MMonad (FreeT f)</code>と<code>f</code>を固定して<code>m</code>を引数と見るのでなく、<code>m</code>を固定して<code>f</code>を引数と見るなら、<a href="https://github.com/viercc/kitchen-sink-hs/blob/master/experiment/src/FreeT_FMonad.md"><code>FreeT _ m</code>は<code>FMonad</code>です</a>。</p>
<p><sup>[2]</sup> IxState: 下記のもの。<code>s</code>が反変な位置にあるので<code>FMonad</code>になれません。 あと、<code>x</code>として、GADTを使ったものを入れないと、 計算後の状態の型がわからなくなるので、<code>Functor</code>な<code>x</code>だけを使うとかなり不便です。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">IxState</span> x s <span class="kw">where</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">IxState</span><span class="ot"> ::</span> (s <span class="ot">-&gt;</span> (t, x t)) <span class="ot">-&gt;</span> <span class="dt">IxState</span> x s</span></code></pre></div>
    </section>
</article>

        </main>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
    </body>
</html>
